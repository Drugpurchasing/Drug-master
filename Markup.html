<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โปรแกรมคำนวนราคา Mark up</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f4f7f6;
            padding-top: 20px;
            padding-bottom: 20px;
        }

        .card {
            border: none;
            border-radius: 0.75rem;
        }

        .card-header {
            background-color: #1A5276; /* Dark Blue */
            color: #ffffff;
            font-weight: 500;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            padding: 1rem 1.5rem;
        }
        
        .card-header h3 {
            font-size: 1.2rem;
        }

        .btn i {
            margin-right: 5px;
        }

        .input-group-text {
            min-width: 100px;
            justify-content: center;
            background-color: #e9ecef;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .shortcut-info {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
        }
        
        #results-container thead {
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .compare-header {
            background-color: #D35400; /* Orange */
        }
        
        .btn-compare {
            background-color: #E67E22;
            border-color: #E67E22;
        }
        .btn-compare:hover {
            background-color: #D35400;
            border-color: #D35400;
        }

        /* Styles for the modal content */
        .modal-body .markup-info-content {
            font-size: 0.9em;
        }
        .modal-body .markup-info-content h5,
        .modal-body .markup-info-content h6 {
            color: #1A5276;
            font-weight: 600;
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 1em;
        }
        .modal-body .markup-info-content h5 {
            font-size: 1.1em;
        }
        .modal-body .markup-info-content table {
            width: 100%;
            margin-top: 5px;
            border-collapse: collapse;
        }
        .modal-body .markup-info-content th,
        .modal-body .markup-info-content td {
            border: 1px solid #dee2e6;
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
        }
        .modal-body .markup-info-content th {
            background-color: #f0f4f4;
            font-weight: 500;
        }
        .modal-body .markup-info-content .new-formula-header {
            background-color: #fff3cd;
            color: #664d03;
        }
        .modal-body .markup-info-content .alert-info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
            padding: 6px 10px;
            border-radius: 0.25rem;
            margin-top: 8px;
            font-size: 0.9em;
        }
        .modal-body .markup-info-content p {
            margin-bottom: 5px;
        }
        #calculationDetailBody h6 {
             color: #1A5276; font-weight: bold; border-bottom: 1px solid #dee2e6; padding-bottom: 5px; margin-top:1rem;
        }
        #calculationDetailBody .calc-step {
            display: flex; justify-content: space-between; padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin-bottom: 2px;
        }
         #calculationDetailBody .calc-step .label { color: #495057; }
         #calculationDetailBody .calc-step .value { font-weight: 500; }
         #calculationDetailBody .calc-step.sub-result { background-color: #e9ecef;}
         #calculationDetailBody .calc-step.final-result {
            font-weight: bold;
            font-size: 1.1em;
            color: #D35400;
            background-color: #fff3cd;
            margin-top: 5px;
         }

    </style>
</head>

<body>

    <div class="container">
        <div class="row justify-content-center g-4">
            <div class="col-lg-11 col-xl-10">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0"><i class="bi bi-calculator-fill"></i> โปรแกรมคำนวนราคา Mark up กรมบัญชีกลาง</h3>
                    </div>
                    <div class="card-body p-4">
                        <div id="input-container">
                            <div class="input-row mb-2">
                                <div class="input-group">
                                    <span class="input-group-text">ราคาต้นทุน</span>
                                    <input type="number" class="form-control cost-input" step="0.01" min="0" placeholder="0.00">
                                    <span class="input-group-text">จำนวน/กล่อง</span>
                                    <input type="number" class="form-control units-per-box" step="1" min="1" value="1">
                                    <span class="input-group-text">ส่วนแถม %</span>
                                    <input type="number" class="form-control bonus-input" step="0.01" min="0" max="100" value="0">
                                    <button class="btn btn-outline-danger remove-row" type="button"><i class="bi bi-x-lg"></i></button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex flex-wrap gap-2 my-3">
                            <button class="btn btn-success" onclick="addNewRow()"><i class="bi bi-plus-circle"></i> เพิ่มรายการ</button>
                            <button class="btn btn-primary" onclick="calculateAll()"><i class="bi bi-arrow-clockwise"></i> คำนวณทั้งหมด</button>
                            <button class="btn btn-info text-white" onclick="exportToExcel()"><i class="bi bi-file-earmark-spreadsheet"></i> Export to Excel</button>
                            <button class="btn btn-danger" onclick="clearAll()"><i class="bi bi-trash"></i> ล้างข้อมูล</button>
                            <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#markupInfoModal">
                                <i class="bi bi-info-circle"></i> ดูหลักเกณฑ์การคำนวณ Mark up
                            </button>
                        </div>

                        <div class="shortcut-info">
                            <p class="mb-1"><b>Shortcuts:</b> กด `Enter` เพื่อคำนวณ | `Ctrl + Enter` เพื่อเพิ่มรายการ | `Ctrl + V` เพื่อวางข้อมูลจาก Excel (3 คอลัมน์)</p>
                        </div>

                        <div id="results" class="mt-4 table-responsive" style="max-height: 50vh;">
                            <div id="results-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-11 col-xl-10">
                <div class="card shadow-sm">
                    <div class="card-header compare-header">
                        <h3 class="mb-0"><i class="bi bi-arrow-left-right"></i> เปรียบเทียบราคา</h3>
                    </div>
                    <div class="card-body p-4">
                        <div class="input-group mb-3">
                            <span class="input-group-text">ราคาเก่า</span>
                            <input type="number" id="oldPrice" class="form-control" step="0.01" min="0">
                            <span class="input-group-text">ราคาใหม่</span>
                            <input type="number" id="newPrice" class="form-control" step="0.01" min="0">
                            <button class="btn btn-compare text-white" onclick="comparePrice()"><i class="bi bi-check2-circle"></i> เปรียบเทียบ</button>
                        </div>
                        <div id="compareResult"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-11 col-xl-10 footer">
                <p>Developed by BG | Enhanced by Gemini</p>
            </div>
        </div>
    </div>

    <div class="modal fade" id="markupInfoModal" tabindex="-1" aria-labelledby="markupInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="markupInfoModalLabel"><i class="bi bi-info-circle"></i> หลักเกณฑ์การคำนวณ Mark up</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="markup-info-content">
                        <h5>1. สูตรปัจจุบัน (กรมบัญชีกลาง)</h5>
                        <table>
                            <thead>
                                <tr>
                                    <th>ราคาต้นทุน/หน่วย (บาท)</th>
                                    <th>วิธีการคำนวณราคาเบิกจ่าย (Reimbursement)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>0.01 - 0.20</td><td>0.50 บาท</td></tr>
                                <tr><td>0.21 - 0.50</td><td>1.00 บาท</td></tr>
                                <tr><td>0.51 - 1.00</td><td>1.50 บาท</td></tr>
                                <tr><td>1.01 - 10.00</td><td>1.50 + (Cost - 1) × 125%</td></tr>
                                <tr><td>10.01 - 100.00</td><td>13 + (Cost - 10) × 120%</td></tr>
                                <tr><td>100.01 - 1000.00</td><td>126 + (Cost - 100) × 115%</td></tr>
                                <tr><td>> 1000.00</td><td>1161 + (Cost - 1000) × 110%</td></tr>
                            </tbody>
                        </table>
                        <div class="alert alert-warning mt-2" role="alert">
                            <strong>การปัดเศษ (ใหม่):</strong><br>
                            - เศษทศนิยม <b>0.01 - 0.50</b>: ปัดขึ้นเป็น <b>.50</b> (เช่น 10.25 หรือ 10.49 จะเป็น 10.50)<br>
                            - เศษทศนิยม <b>> 0.50</b>: ปัดขึ้นเป็น<b>จำนวนเต็มถัดไป</b> (เช่น 10.51 จะเป็น 11.00)
                        </div>

                        <h5 class="mt-4">2. สูตรคำนวณใหม่ (พิจารณาใช้ประกอบ)</h5>
                        <p>สูตรนี้ใช้การเพิ่ม Mark up Percentage เข้าไปที่ <strong>ราคาต้นทุนสุทธิ/หน่วย</strong> ก่อนที่จะนำไปคำนวณด้วยสูตรกรมบัญชีกลางปัจจุบัน</p>
                        <table>
                            <thead>
                                <tr class="new-formula-header">
                                    <th>ราคาต้นทุนสุทธิ/หน่วย (บาท)</th>
                                    <th>Markup Percentage (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>< 1 - 99.99</td><td>40%</td></tr>
                                <tr><td>100 - 999.99</td><td>30%</td></tr>
                                <tr><td>1000 - 4999.99</td><td>20%</td></tr>
                                <tr><td>5000 - 9999.99</td><td>20%</td></tr>
                                <tr><td>10000 - 49999.99</td><td>15%</td></tr>
                                <tr><td>50000 - 99999.99</td><td>15%</td></tr>
                                <tr><td>>= 100000</td><td>10%</td></tr>
                            </tbody>
                        </table>
                        <div class="alert alert-info mt-2" role="alert">
                            <strong>ขั้นตอนการคำนวณราคาขายสูตรใหม่:</strong><br>
                            1. คำนวณส่วนต่างราคาเบิก: `ส่วนต่าง = (ราคาเบิกจากทุนหลัง Mark up) - (ราคาเบิกจากทุนสุทธิ)`<br>
                            2. คำนวณราคาใหม่: `ราคาใหม่ = ทุนสุทธิ/หน่วย + ส่วนต่าง`<br>
                            3. นำราคาใหม่ที่ได้ไปปัดเศษตามเกณฑ์ใหม่ข้างต้น
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="calculationDetailModal" tabindex="-1" aria-labelledby="calculationDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="calculationDetailModalLabel"><i class="bi bi-body-text"></i> รายละเอียดการคำนวณ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="calculationDetailBody">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>


<script>
    // --- START: CALCULATION LOGIC ---
    function getNewMarkupPercentageValue(cost) {
        cost = parseFloat(cost);
        if (cost >= 0.01 && cost <= 99.99) return 0.40;
        if (cost >= 100 && cost <= 999.99) return 0.30;
        if (cost >= 1000 && cost <= 4999.99) return 0.20;
        if (cost >= 5000 && cost <= 9999.99) return 0.20;
        if (cost >= 10000 && cost <= 49999.99) return 0.15;
        if (cost >= 50000 && cost <= 99999.99) return 0.15;
        if (cost >= 100000) return 0.10;
        return 0;
    }

    function calculateNewMarkupCost(cost) {
        const markup = getNewMarkupPercentageValue(cost);
        return cost * (1 + markup);
    }
    
    /**
     * Applies the new custom rounding logic.
     * - If decimal is > 0 and <= 0.50, rounds up to .50.
     * - If decimal is > 0.50, rounds up to the next integer.
     * @param {number} price The price to round.
     * @returns {number} The rounded price.
     */
    function applyRounding(price) {
        price = parseFloat(price);
        const integerPart = Math.floor(price);
        const decimalPart = price - integerPart;

        // Use a small epsilon for floating point comparisons
        const epsilon = 0.00001;

        // If decimal part is essentially zero, return the integer part.
        if (decimalPart < epsilon) {
            return integerPart;
        }
        
        // If 0 < decimal <= 0.50, round up to .5
        if (decimalPart > 0 && decimalPart <= (0.5 + epsilon)) {
            return integerPart + 0.5;
        }

        // If decimal > 0.50, round up to the next integer
        if (decimalPart > 0.5) {
            return integerPart + 1;
        }

        // Fallback, should not be reached with the logic above
        return price;
    }

    function calculateSingle(cost) {
        let reimbursement = 0;
        cost = parseFloat(cost);

        if (cost >= 0.01 && cost <= 0.20) { reimbursement = 0.50; } 
        else if (cost <= 0.50) { reimbursement = 1.00; } 
        else if (cost <= 1.00) { reimbursement = 1.50; } 
        else if (cost <= 10.00) { reimbursement = 1.50 + ((cost - 1) * 1.25); } 
        else if (cost <= 100.00) { reimbursement = 13 + ((cost - 10) * 1.20); } 
        else if (cost <= 1000.00) { reimbursement = 126 + ((cost - 100) * 1.15); } 
        else if (cost > 1000){ reimbursement = 1161 + ((cost - 1000) * 1.10); }
        else { reimbursement = 0; }
        
        return applyRounding(reimbursement);
    }
    // --- END: CALCULATION LOGIC ---


    function addNewRow(cost = '', units = '1', bonus = '0') {
        const container = document.getElementById('input-container');
        const newRow = document.createElement('div');
        newRow.className = 'input-row mb-2';
        newRow.innerHTML = `
        <div class="input-group">
            <span class="input-group-text">ราคาต้นทุน</span>
            <input type="number" class="form-control cost-input" step="0.01" min="0" value="${cost}" placeholder="0.00">
            <span class="input-group-text">จำนวน/กล่อง</span>
            <input type="number" class="form-control units-per-box" step="1" min="1" value="${units}">
            <span class="input-group-text">ส่วนแถม %</span>
            <input type="number" class="form-control bonus-input" step="0.01" min="0" max="100" value="${bonus}">
            <button class="btn btn-outline-danger remove-row" type="button"><i class="bi bi-x-lg"></i></button>
        </div>`;
        container.appendChild(newRow);
        newRow.querySelector('.remove-row').addEventListener('click', function() {
            newRow.remove();
            calculateAll();
        });
        if (!cost) {
            newRow.querySelector('.cost-input').focus();
        }
    }

    function clearAll() {
        const container = document.getElementById('input-container');
        while (container.children.length > 1) {
            container.removeChild(container.lastChild);
        }
        const firstRow = container.querySelector('.input-row');
        if (firstRow) {
            firstRow.querySelector('.cost-input').value = '';
            firstRow.querySelector('.units-per-box').value = '1';
            firstRow.querySelector('.bonus-input').value = '0';
            firstRow.querySelector('.cost-input').focus();
        }
        document.getElementById('results-container').innerHTML = '';
        document.getElementById('compareResult').innerHTML = '';
        document.getElementById('oldPrice').value = '';
        document.getElementById('newPrice').value = '';
    }

    function formatNumber(number) {
        if (isNaN(parseFloat(number))) return "0.00";
        let parts = parseFloat(number).toFixed(2).split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join('.');
    }
    
    function formatNumberDetailed(number) {
        if (isNaN(parseFloat(number))) return "0.0000";
        let parts = parseFloat(number).toFixed(4).split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join('.');
    }

    function calculateAll() {
        const resultsContainer = document.getElementById('results-container');
        resultsContainer.innerHTML = '';

        const inputs = document.querySelectorAll('.cost-input');
        if (inputs.length === 0 || (inputs.length === 1 && !inputs[0].value)) return;

        let tableHeaders = `
            <tr class="text-center">
                <th>#</th>
                <th>ทุนสุทธิ/หน่วย</th>
                <th>ราคาเบิก กบก.</th>
                <th>ราคาขายสูตรใหม่</th>
                <th>รายละเอียด</th>
            </tr>`;

        const table = document.createElement('table');
        table.className = 'table table-striped table-bordered table-hover';
        table.innerHTML = `<thead>${tableHeaders}</thead><tbody></tbody>`;
        const tbody = table.querySelector('tbody');

        document.querySelectorAll('.input-row').forEach((row, index) => {
            const originalCostInput = row.querySelector('.cost-input').value;
            const originalCost = parseFloat(originalCostInput);
            const bonusPercentage = parseFloat(row.querySelector('.bonus-input').value) || 0;
            const units = parseInt(row.querySelector('.units-per-box').value) || 1;

            if (!isNaN(originalCost) && originalCostInput !== '') {
                const adjustedCost = originalCost * (100 / (100 + bonusPercentage));
                const unitCost = adjustedCost / units;

                // --- CALCULATIONS START ---
                // 1. CGD Formula (Old)
                const cgdReimbursement = calculateSingle(unitCost);
                
                // 2. New Formula
                const newMarkupPercent = getNewMarkupPercentageValue(unitCost);
                const costAfterMarkup = calculateNewMarkupCost(unitCost);
                const markupReimbursement = calculateSingle(costAfterMarkup);
                const reimbursementDifference = markupReimbursement - cgdReimbursement;
                const preliminaryNewPrice = unitCost + reimbursementDifference;
                const newFormulaReimbursement = applyRounding(preliminaryNewPrice);
                // --- CALCULATIONS END ---

                // Prepare data for the detail view modal
                const detailParams = {
                    unitCost: unitCost,
                    cgdPrice: cgdReimbursement,
                    markupPercent: newMarkupPercent * 100,
                    costAfterMarkup: costAfterMarkup,
                    markupReimbursement: markupReimbursement,
                    reimbursementDifference: reimbursementDifference,
                    preliminaryNewPrice: preliminaryNewPrice,
                    newFormulaPrice: newFormulaReimbursement
                };

                let tableRowHtml = `
                    <td class="text-center">${index + 1}</td>
                    <td class="text-end">${formatNumberDetailed(unitCost)}</td>
                    <td class="text-end fw-bold text-primary">${formatNumber(cgdReimbursement)}</td>
                    <td class="text-end fw-bold text-danger">${formatNumber(newFormulaReimbursement)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-info" onclick='showCalculationDetails(${JSON.stringify(detailParams)})'>
                            <i class="bi bi-search"></i>
                        </button>
                    </td>
                `;

                const tr = document.createElement('tr');
                tr.innerHTML = tableRowHtml;
                tbody.appendChild(tr);
            }
        });
        if (tbody.children.length > 0) {
            resultsContainer.appendChild(table);
        }
    }

    function showCalculationDetails(params) {
        const modalBody = document.getElementById('calculationDetailBody');
        modalBody.innerHTML = `
            <h6><i class="bi bi-journal-bookmark-fill"></i> ราคาเบิก กบก.</h6>
            <div class="calc-step">
                <span class="label">ทุนสุทธิ/หน่วย:</span>
                <span class="value">${formatNumberDetailed(params.unitCost)}</span>
            </div>
            <div class="calc-step final-result">
                <span class="label">ราคาเบิก กบก.:</span>
                <span class="value">${formatNumber(params.cgdPrice)}</span>
            </div>
            
            <h6 class="mt-4"><i class="bi bi-stars"></i> ราคาขายสูตรใหม่</h6>
            <div class="calc-step">
                <span class="label">ทุนหลัง Mark up (${params.markupPercent.toFixed(0)}%):</span>
                <span class="value">${formatNumberDetailed(params.costAfterMarkup)}</span>
            </div>
            <div class="calc-step sub-result">
                <span class="label">ราคาเบิก (จากทุนหลัง Mark up):</span>
                <span class="value">${formatNumber(params.markupReimbursement)}</span>
            </div>
            <div class="calc-step sub-result">
                <span class="label">ราคาเบิก (จากทุนสุทธิ):</span>
                <span class="value">-${formatNumber(params.cgdPrice)}</span>
            </div>
            <div class="calc-step">
                <span class="label fw-bold">ส่วนต่างราคาเบิก:</span>
                <span class="value fw-bold">${formatNumberDetailed(params.reimbursementDifference)}</span>
            </div>
            <hr class="my-2">
             <div class="calc-step">
                <span class="label">ทุนสุทธิ/หน่วย:</span>
                <span class="value">${formatNumberDetailed(params.unitCost)}</span>
            </div>
            <div class="calc-step">
                <span class="label">บวก ส่วนต่างราคาเบิก:</span>
                <span class="value">+${formatNumberDetailed(params.reimbursementDifference)}</span>
            </div>
            <div class="calc-step sub-result">
                <span class="label">ราคาก่อนปัดเศษ:</span>
                <span class="value">${formatNumberDetailed(params.preliminaryNewPrice)}</span>
            </div>
            <div class="calc-step final-result">
                <span class="label">ราคาขายสูตรใหม่ (หลังปัดเศษ):</span>
                <span class="value">${formatNumber(params.newFormulaPrice)}</span>
            </div>
        `;

        const detailModal = new bootstrap.Modal(document.getElementById('calculationDetailModal'));
        detailModal.show();
    }


    function exportToExcel() {
        let headers = ['#', 'ต้นทุนเดิม', 'ส่วนแถม %', 'จำนวน/หน่วย', 'ทุนสุทธิ/หน่วย', 'ราคาเบิก กบก.', 'ราคาขายสูตรใหม่'];
        let data = [headers];

        document.querySelectorAll('.input-row').forEach((row, index) => {
            const originalCostInput = row.querySelector('.cost-input').value;
            const originalCost = parseFloat(originalCostInput);
            const bonusPercentage = parseFloat(row.querySelector('.bonus-input').value) || 0;
            const units = parseInt(row.querySelector('.units-per-box').value) || 1;

            if (!isNaN(originalCost) && originalCostInput !== '') {
                const adjustedCost = originalCost * (100 / (100 + bonusPercentage));
                const unitCost = adjustedCost / units;
                
                const cgdReimbursement = calculateSingle(unitCost);
                const costAfterMarkup = calculateNewMarkupCost(unitCost);
                const markupReimbursement = calculateSingle(costAfterMarkup);
                const reimbursementDifference = markupReimbursement - cgdReimbursement;
                const preliminaryNewPrice = unitCost + reimbursementDifference;
                const newFormulaReimbursement = applyRounding(preliminaryNewPrice);
                
                let rowData = [
                    index + 1,
                    originalCost,
                    bonusPercentage,
                    units,
                    Number(unitCost.toFixed(4)),
                    Number(cgdReimbursement.toFixed(2)),
                    Number(newFormulaReimbursement.toFixed(2))
                ];
                data.push(rowData);
            }
        });
        
        if (data.length <= 1) { alert("ไม่มีข้อมูลสำหรับส่งออก"); return; }
        
        const ws = XLSX.utils.aoa_to_sheet(data);
        ws['!cols'] = headers.map(() => ({ wch: 18 }));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Price Calculations");
        XLSX.writeFile(wb, "price_calculations_new.xlsx");
    }

    function comparePrice() {
        const oldPrice = parseFloat(document.getElementById('oldPrice').value) || 0;
        const newPrice = parseFloat(document.getElementById('newPrice').value) || 0;
        const resultDiv = document.getElementById('compareResult');
        if (isNaN(oldPrice) || isNaN(newPrice) || oldPrice <= 0) {
            resultDiv.innerHTML = `<p class="text-danger mt-3">กรุณากรอกตัวเลขที่ถูกต้อง และราคาเก่าต้องมากกว่า 0</p>`;
            return;
        }
        const difference = newPrice - oldPrice;
        const percentDiff = oldPrice !== 0 ? ((difference / oldPrice) * 100) : 0;
        const sign = percentDiff >= 0 ? '+' : '';
        const alertClass = difference >= 0 ? 'alert-danger' : 'alert-success';

        resultDiv.innerHTML = `
        <div class="alert ${alertClass} mt-3">
            <p class="mb-1"><strong>ส่วนต่าง:</strong> ${formatNumber(difference)} บาท</p>
            <p class="mb-0"><strong>เปอร์เซ็นต์เปลี่ยนแปลง:</strong> <span class="fw-bold">${sign}${percentDiff.toFixed(2)}%</span></p>
        </div>`;
    }

    // Event Listeners
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) { addNewRow(); } 
        else if (e.key === 'Enter') {
             if(document.activeElement.id === 'oldPrice' || document.activeElement.id === 'newPrice'){
                 comparePrice();
             } else if (document.activeElement.classList.contains('cost-input')) {
                 calculateAll();
             }
        }
    });

    document.addEventListener('paste', function(e) {
        if (!e.target.classList.contains('cost-input')) {
            return;
        }
        e.preventDefault();
        let pastedData = (e.clipboardData || window.clipboardData).getData('text');
        let rows = pastedData.split(/\r\n|\r|\n/).filter(row => row.trim());
        if(rows.length > 0) clearAll();

        rows.forEach((row, index) => {
            const values = row.split(/\t/);
            const cost = parseFloat(values[0]?.replace(/,/g, '')) || '';
            const units = parseFloat(values[1]) || '1';
            const bonus = parseFloat(values[2]) || '0';
            
            if (index === 0) {
                 const firstRow = document.querySelector('.input-row');
                 firstRow.querySelector('.cost-input').value = cost;
                 firstRow.querySelector('.units-per-box').value = units;
                 firstRow.querySelector('.bonus-input').value = bonus;
            } else {
                if (!isNaN(cost) && cost !== '') { addNewRow(cost, units, bonus); }
            }
        });
        if(rows.length > 0) calculateAll();
    });
    
    document.querySelector('.remove-row').addEventListener('click', function(e) {
        if (document.querySelectorAll('.input-row').length > 1) {
            e.target.closest('.input-row').remove();
            calculateAll();
        } else {
            const firstRow = document.querySelector('.input-row');
            firstRow.querySelector('.cost-input').value = '';
            firstRow.querySelector('.units-per-box').value = '1';
            firstRow.querySelector('.bonus-input').value = '0';
            calculateAll();
        }
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


