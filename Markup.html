<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โปรแกรมคำนวนราคา Mark up</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f4f7f6;
            padding-top: 20px;
            padding-bottom: 20px;
        }

        .card {
            border: none;
            border-radius: 0.75rem;
        }

        .card-header {
            background-color: #1A5276; /* Dark Blue */
            color: #ffffff;
            font-weight: 500;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            padding: 1rem 1.5rem;
        }
        
        .card-header h3 {
             font-size: 1.2rem;
        }

        .btn i {
            margin-right: 5px;
        }

        .input-group-text {
            min-width: 100px;
            justify-content: center;
            background-color: #e9ecef;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .shortcut-info {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
        }
        
        #results-container thead {
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .form-check-label {
            font-weight: 500;
        }
        
        .compare-header {
             background-color: #D35400; /* Orange */
        }
        
        .btn-compare {
            background-color: #E67E22;
            border-color: #E67E22;
        }
        .btn-compare:hover {
            background-color: #D35400;
            border-color: #D35400;
        }

    </style>
</head>

<body>

    <div class="container">
        <div class="row justify-content-center g-4">
            <div class="col-lg-11 col-xl-10">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0"><i class="bi bi-calculator-fill"></i> โปรแกรมคำนวนราคา Mark up กรมบัญชีกลาง</h3>
                    </div>
                    <div class="card-body p-4">
                        <div id="input-container">
                            <div class="input-row mb-2">
                                <div class="input-group">
                                    <span class="input-group-text">ราคาต้นทุน</span>
                                    <input type="number" class="form-control cost-input" step="0.01" min="0" placeholder="0.00">
                                    <span class="input-group-text">จำนวน/กล่อง</span>
                                    <input type="number" class="form-control units-per-box" step="1" min="1" value="1">
                                    <span class="input-group-text">ส่วนแถม %</span>
                                    <input type="number" class="form-control bonus-input" step="0.01" min="0" max="100" value="0">
                                    <button class="btn btn-outline-danger remove-row" type="button"><i class="bi bi-x-lg"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="form-check form-switch my-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="newFormulaToggle" onclick="calculateAll()">
                            <label class="form-check-label" for="newFormulaToggle">
                                เปิดใช้งานสูตรคำนวณใหม่ <span class="badge bg-warning text-dark">ยังไม่ประกาศใช้</span>
                            </label>
                        </div>
                        
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button class="btn btn-success" onclick="addNewRow()"><i class="bi bi-plus-circle"></i> เพิ่มรายการ</button>
                            <button class="btn btn-primary" onclick="calculateAll()"><i class="bi bi-arrow-clockwise"></i> คำนวณทั้งหมด</button>
                            <button class="btn btn-info text-white" onclick="exportToExcel()"><i class="bi bi-file-earmark-spreadsheet"></i> Export to Excel</button>
                            <button class="btn btn-danger" onclick="clearAll()"><i class="bi bi-trash"></i> ล้างข้อมูล</button>
                        </div>

                        <div class="shortcut-info">
                            <p class="mb-1"><b>Shortcuts:</b> กด `Enter` เพื่อคำนวณ | `Ctrl + Enter` เพื่อเพิ่มรายการ | `Ctrl + V` เพื่อวางข้อมูลจาก Excel (3 คอลัมน์)</p>
                        </div>

                        <div id="results" class="mt-4 table-responsive" style="max-height: 50vh;">
                            <div id="results-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-11 col-xl-10">
                <div class="card shadow-sm">
                    <div class="card-header compare-header">
                        <h3 class="mb-0"><i class="bi bi-arrow-left-right"></i> เปรียบเทียบราคา</h3>
                    </div>
                    <div class="card-body p-4">
                        <div class="input-group mb-3">
                            <span class="input-group-text">ราคาเก่า</span>
                            <input type="number" id="oldPrice" class="form-control" step="0.01" min="0">
                            <span class="input-group-text">ราคาใหม่</span>
                            <input type="number" id="newPrice" class="form-control" step="0.01" min="0">
                            <button class="btn btn-compare text-white" onclick="comparePrice()"><i class="bi bi-check2-circle"></i> เปรียบเทียบ</button>
                        </div>
                        <div id="compareResult"></div>
                    </div>
                </div>
            </div>
             <div class="col-lg-11 col-xl-10 footer">
                 <p>Developed by BG | Enhanced by Gemini</p>
            </div>
        </div>
    </div>

<script>
    // --- START: NEW CALCULATION LOGIC ---
    function getNewMarkupPercentage(cost) {
        cost = parseFloat(cost);
        if (cost <= 99) return 0.40;
        if (cost <= 999) return 0.30;
        if (cost <= 9999) return 0.20;
        if (cost <= 99999) return 0.15;
        return 0.10;
    }

    function calculateNewMarkupCost(cost) {
        const markup = getNewMarkupPercentage(cost);
        return cost * (1 + markup);
    }
    // --- END: NEW CALCULATION LOGIC ---

    function calculateSingle(cost) {
        let reimbursement = 0;
        cost = parseFloat(cost);

        if (cost >= 0.01 && cost <= 0.20) { reimbursement = 0.50; } 
        else if (cost <= 0.50) { reimbursement = 1.00; } 
        else if (cost <= 1.00) { reimbursement = 1.50; } 
        else if (cost <= 10.00) { reimbursement = 1.50 + ((cost - 1) * 1.25); } 
        else if (cost <= 100.00) { reimbursement = 13 + ((cost - 10) * 1.20); } 
        else if (cost <= 1000.00) { reimbursement = 126 + ((cost - 100) * 1.15); } 
        else { reimbursement = 1161 + ((cost - 1000) * 1.10); }

        if (reimbursement < 10) { return Math.round(reimbursement * 4) / 4; } 
        else if (reimbursement <= 100) { return Math.round(reimbursement * 2) / 2; } 
        else { return Math.round(reimbursement); }
    }

    function addNewRow(cost = '', units = '1', bonus = '0') {
        const container = document.getElementById('input-container');
        const newRow = document.createElement('div');
        newRow.className = 'input-row mb-2';
        newRow.innerHTML = `
        <div class="input-group">
            <span class="input-group-text">ราคาต้นทุน</span>
            <input type="number" class="form-control cost-input" step="0.01" min="0" value="${cost}" placeholder="0.00">
            <span class="input-group-text">จำนวน/กล่อง</span>
            <input type="number" class="form-control units-per-box" step="1" min="1" value="${units}">
            <span class="input-group-text">ส่วนแถม %</span>
            <input type="number" class="form-control bonus-input" step="0.01" min="0" max="100" value="${bonus}">
            <button class="btn btn-outline-danger remove-row" type="button"><i class="bi bi-x-lg"></i></button>
        </div>`;
        container.appendChild(newRow);
        newRow.querySelector('.remove-row').addEventListener('click', function() {
            newRow.remove();
        });
        if (!cost) {
            newRow.querySelector('.cost-input').focus();
        }
    }

    // --- START: NEW CLEAR ALL FUNCTION ---
    function clearAll() {
        const container = document.getElementById('input-container');
        while (container.children.length > 1) {
            container.removeChild(container.lastChild);
        }
        const firstRow = container.querySelector('.input-row');
        if (firstRow) {
            firstRow.querySelector('.cost-input').value = '';
            firstRow.querySelector('.units-per-box').value = '1';
            firstRow.querySelector('.bonus-input').value = '0';
            firstRow.querySelector('.cost-input').focus();
        }
        document.getElementById('results-container').innerHTML = '';
        document.getElementById('compareResult').innerHTML = '';
        document.getElementById('oldPrice').value = '';
        document.getElementById('newPrice').value = '';
        document.getElementById('newFormulaToggle').checked = false;
    }
    // --- END: NEW CLEAR ALL FUNCTION ---

    function formatNumber(number) {
        if (isNaN(parseFloat(number))) return "0.00";
        return parseFloat(number).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // --- START: UPDATED CALCULATE ALL FUNCTION ---
    function calculateAll() {
        const useNewFormula = document.getElementById('newFormulaToggle').checked;
        const resultsContainer = document.getElementById('results-container');
        resultsContainer.innerHTML = '';

        const inputs = document.querySelectorAll('.cost-input');
        if (inputs.length === 0 || (inputs.length === 1 && !inputs[0].value)) return;

        let tableHeaders = `
            <tr class="text-center">
                <th>#</th>
                <th>ทุนสุทธิ/หน่วย</th>
                <th>ราคาเบิก (เดิม)</th>
                <th>กำไร (เดิม)</th>
                <th>กำไร % (เดิม)</th>
        `;

        if (useNewFormula) {
            tableHeaders += `
                <th class="bg-warning">ทุน (ใหม่)</th>
                <th class="bg-warning">ราคาเบิก (ใหม่)</th>
                <th class="bg-warning">กำไร (ใหม่)</th>
                <th class="bg-warning">กำไร % (ใหม่)</th>
            `;
        }
        tableHeaders += `</tr>`;

        const table = document.createElement('table');
        table.className = 'table table-striped table-bordered table-hover';
        table.innerHTML = `<thead>${tableHeaders}</thead><tbody></tbody>`;
        const tbody = table.querySelector('tbody');

        document.querySelectorAll('.input-row').forEach((row, index) => {
            const originalCost = parseFloat(row.querySelector('.cost-input').value);
            const bonusPercentage = parseFloat(row.querySelector('.bonus-input').value) || 0;
            const units = parseInt(row.querySelector('.units-per-box').value) || 1;

            if (!isNaN(originalCost)) {
                const adjustedCost = originalCost * (100 / (100 + bonusPercentage));
                const unitCost = adjustedCost / units;

                // Original Formula
                const originalReimbursement = calculateSingle(unitCost);
                const originalMargin = originalReimbursement - unitCost;
                const originalMarginPercent = unitCost > 0 ? (originalMargin / unitCost) * 100 : 0;
                
                let tableRowHtml = `
                    <td class="text-center">${index + 1}</td>
                    <td class="text-end">${formatNumber(unitCost)}</td>
                    <td class="text-end fw-bold">${formatNumber(originalReimbursement)}</td>
                    <td class="text-end ${originalMargin >= 0 ? 'text-success' : 'text-danger'}">${formatNumber(originalMargin)}</td>
                    <td class="text-end ${originalMarginPercent >= 0 ? 'text-success' : 'text-danger'}">${originalMarginPercent.toFixed(2)}%</td>
                `;

                // New Formula (if toggled)
                if (useNewFormula) {
                    const costAfterMarkup = calculateNewMarkupCost(unitCost);
                    const newReimbursement = calculateSingle(costAfterMarkup);
                    const newMargin = newReimbursement - unitCost;
                    const newMarginPercent = unitCost > 0 ? (newMargin / unitCost) * 100 : 0;
                    
                    tableRowHtml += `
                        <td class="text-end bg-light">${formatNumber(costAfterMarkup)}</td>
                        <td class="text-end fw-bold bg-light">${formatNumber(newReimbursement)}</td>
                        <td class="text-end ${newMargin >= 0 ? 'text-success' : 'text-danger'} bg-light">${formatNumber(newMargin)}</td>
                        <td class="text-end ${newMarginPercent >= 0 ? 'text-success' : 'text-danger'} bg-light">${newMarginPercent.toFixed(2)}%</td>
                    `;
                }
                const tr = document.createElement('tr');
                tr.innerHTML = tableRowHtml;
                tbody.appendChild(tr);
            }
        });
        resultsContainer.appendChild(table);
    }
    // --- END: UPDATED CALCULATE ALL FUNCTION ---

    // --- START: UPDATED EXPORT TO EXCEL FUNCTION ---
    function exportToExcel() {
        const useNewFormula = document.getElementById('newFormulaToggle').checked;
        let headers = ['#', 'ต้นทุนเดิม', 'ส่วนแถม %', 'จำนวน/หน่วย', 'ทุนสุทธิ/หน่วย', 'ราคาเบิก (เดิม)', 'กำไร (เดิม)', 'กำไร % (เดิม)'];
        if (useNewFormula) {
            headers.push('ทุน (ใหม่)', 'ราคาเบิก (ใหม่)', 'กำไร (ใหม่)', 'กำไร % (ใหม่)');
        }
        let data = [headers];

        document.querySelectorAll('.input-row').forEach((row, index) => {
            const originalCost = parseFloat(row.querySelector('.cost-input').value);
            const bonusPercentage = parseFloat(row.querySelector('.bonus-input').value) || 0;
            const units = parseInt(row.querySelector('.units-per-box').value) || 1;

            if (!isNaN(originalCost)) {
                const adjustedCost = originalCost * (100 / (100 + bonusPercentage));
                const unitCost = adjustedCost / units;
                
                const originalReimbursement = calculateSingle(unitCost);
                const originalMargin = originalReimbursement - unitCost;
                const originalMarginPercent = unitCost > 0 ? (originalMargin / unitCost) * 100 : 0;
                
                let rowData = [
                    index + 1,
                    originalCost,
                    bonusPercentage,
                    units,
                    Number(unitCost.toFixed(2)),
                    Number(originalReimbursement.toFixed(2)),
                    Number(originalMargin.toFixed(2)),
                    `${originalMarginPercent.toFixed(2)}%`
                ];

                if (useNewFormula) {
                    const costAfterMarkup = calculateNewMarkupCost(unitCost);
                    const newReimbursement = calculateSingle(costAfterMarkup);
                    const newMargin = newReimbursement - unitCost;
                    const newMarginPercent = unitCost > 0 ? (newMargin / unitCost) * 100 : 0;
                    rowData.push(
                        Number(costAfterMarkup.toFixed(2)),
                        Number(newReimbursement.toFixed(2)),
                        Number(newMargin.toFixed(2)),
                        `${newMarginPercent.toFixed(2)}%`
                    );
                }
                data.push(rowData);
            }
        });
        
        if (data.length <= 1) { alert("ไม่มีข้อมูลสำหรับส่งออก"); return; }
        
        const ws = XLSX.utils.aoa_to_sheet(data);
        ws['!cols'] = headers.map(() => ({ wch: 18 })); // Set column width for all
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Price Calculations");
        XLSX.writeFile(wb, "price_calculations.xlsx");
    }
    // --- END: UPDATED EXPORT TO EXCEL FUNCTION ---

    function comparePrice() {
        const oldPrice = parseFloat(document.getElementById('oldPrice').value) || 0;
        const newPrice = parseFloat(document.getElementById('newPrice').value) || 0;
        const resultDiv = document.getElementById('compareResult');
        if (isNaN(oldPrice) || isNaN(newPrice)) {
            resultDiv.innerHTML = '<p class="text-danger">กรุณากรอกตัวเลขที่ถูกต้อง</p>';
            return;
        }
        const difference = newPrice - oldPrice;
        const percentDiff = oldPrice !== 0 ? ((difference / oldPrice) * 100) : 0;
        const sign = percentDiff > 0 ? '+' : '';

        resultDiv.innerHTML = `
        <div class="alert ${difference >= 0 ? 'alert-danger' : 'alert-success'} mt-3">
            <p><strong>ส่วนต่าง:</strong> ${formatNumber(difference)} บาท</p>
            <p><strong>เปอร์เซ็นต์เปลี่ยนแปลง:</strong> <span class="fw-bold">${sign}${percentDiff.toFixed(2)}%</span></p>
        </div>`;
    }

    // Event Listeners
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) { addNewRow(); } 
        else if (e.key === 'Enter') {
             if(document.activeElement.id === 'oldPrice' || document.activeElement.id === 'newPrice'){
                comparePrice();
             } else {
                calculateAll();
             }
        }
    });

    document.addEventListener('paste', function(e) {
        e.preventDefault();
        let pastedData = (e.clipboardData || window.clipboardData).getData('text');
        let rows = pastedData.split(/\r\n|\r|\n/).filter(row => row.trim());
        if(rows.length > 0) clearAll();

        rows.forEach((row, index) => {
            const values = row.split(/\t/);
            const cost = parseFloat(values[0]?.replace(/,/g, '')) || '';
            const units = parseFloat(values[1]) || '1';
            const bonus = parseFloat(values[2]) || '0';
            
            if (index === 0) {
                 const firstRow = document.querySelector('.input-row');
                 firstRow.querySelector('.cost-input').value = cost;
                 firstRow.querySelector('.units-per-box').value = units;
                 firstRow.querySelector('.bonus-input').value = bonus;
            } else {
                if (!isNaN(cost)) { addNewRow(cost, units, bonus); }
            }
        });
        if(rows.length > 0) calculateAll();
    });
    
    // Initial remove button
    document.querySelector('.remove-row').addEventListener('click', function(e) {
        if (document.querySelectorAll('.input-row').length > 1) {
            e.target.closest('.input-row').remove();
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


