<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เสนอยาเข้าใหม่ คณะทำงาน มิ.ย. 68</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
         html {
    font-size: 20px;
}
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f4f7f9;
        }

        .main-content {
            transition: opacity 0.3s ease-in-out;
        }

        .nav-item {
            transition: all 0.2s ease;
        }

        .nav-item.active {
            background-color: #0077b6;
            color: white;
            border-right: 4px solid #fbaf00;
        }

        .info-card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .info-header {
            color: white;
            padding: 0.75rem 1.25rem;
            font-weight: 700;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
        }

        .info-header .fa-solid {
            margin-right: 0.75rem;
            font-size: 1.65rem;
        }

        .label {
            font-weight: 600;
            color: #4a5568;
            display: block;
            font-size: 1.125rem;
        }

        .value {
            color: #1a202c;
            font-size: 1.125rem;
        }

        .reimburse-no {
            color: #d90429;
            font-weight: 700;
            background-color: #fee2e2;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            display: inline-block;
        }

        .reimburse-yes {
            color: #028a0f;
            font-weight: 700;
            background-color: #dcfce7;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            display: inline-block;
        }
        
        .reimburse-advance {
            color: #1d4ed8; /* Tailwind blue-700 */
            font-weight: 700;
            background-color: #dbeafe; /* Tailwind blue-100 */
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            display: inline-block;
        }

        .pap-card {
            border-top: 4px solid #fbaf00;
        }

        .view-switcher {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #e2e8f0;
            border-radius: 8px;
        }

        .view-switcher-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            background-color: transparent;
            color: #475569;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
        }

        .view-switcher-btn.active {
            background-color: #ffffff;
            color: #0077b6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #summary-table th {
            background-color: #f1f5f9;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #1e293b;
            font-size: 1.2rem;
        }

        #summary-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 1.2rem;
        }

        #summary-table tbody tr:hover {
            background-color: #f8fafc;
        }

        #sticky-drug-header {
            position: sticky;
            top: 0;
            z-index: 10;
            transition: opacity 0.3s ease-in-out;
        }

        .loader {
            text-align: center;
            padding: 2rem;
            font-size: 1.45rem;
            color: #475569;
        }
    </style>
</head>

<body class="bg-gray-100">

    <div class="flex h-screen">
        <aside id="sidebar" class="bg-[#001d3d] text-gray-200 flex-shrink-0 flex flex-col h-screen w-72 transition-all duration-300 ease-in-out overflow-x-hidden">
            <div class="p-4 text-center border-b border-gray-700 flex items-center justify-center space-x-4">
                <i id="sidebar-toggle" class="fa-solid fa-bars text-xl text-white flex-shrink-0 cursor-pointer"></i>
                <h1 class="text-lg font-bold text-white opacity-100 sidebar-text break-words transition-opacity duration-200">รายการยาเข้าใหม่ มิ.ย.68</h1>
            </div>
            <nav id="drug-nav" class="p-2 space-y-1 flex-1 overflow-y-auto">
                <div class="text-center p-4 text-gray-400">
                    <i class="fa-solid fa-spinner fa-spin"></i>
                </div>
            </nav>
        </aside>
        <main class="flex-1 p-4 md:p-8 overflow-y-auto transition-all duration-300 ease-in-out">
            <div class="view-switcher">
                <button id="details-view-btn" class="view-switcher-btn active">รายละเอียดยา</button>
                <button id="table-view-btn" class="view-switcher-btn">ตารางสรุป</button>
            </div>

            <div id="drug-details-view">
                <div id="sticky-drug-header" class="opacity-0"></div>
                <div id="drug-details" class="main-content opacity-100">
                    <div class="loader">กำลังโหลดข้อมูลยา...</div>
                </div>
            </div>

            <div id="summary-table-view" class="hidden">
                 <div id="decision-summary-card" class="info-card mb-6">
                    <div class="info-header bg-[#4a4e69]">
                        <i class="fa-solid fa-chart-pie"></i>
                        <span>สรุปผลการพิจารณา</span>
                    </div>
                    <div id="decision-summary-container" class="p-4 text-xl">
                        <div class="loader">กำลังรวบรวมข้อมูล...</div>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-header bg-[#03045e] justify-between">
                        <div class="flex items-center">
                           <i class="fa-solid fa-table-list"></i>
                           <span>ตารางสรุปรายการยาทั้งหมด</span>
                        </div>
                        <button id="export-excel-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg text-base flex items-center transition-colors duration-200">
                            <i class="fa-solid fa-file-excel mr-2"></i>
                            <span>Export</span>
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="summary-table" class="w-full text-sm">
                            <thead>
                                <tr>
                                    <th>ลำดับ</th>
                                    <th class="w-4/12">รายการยา</th>
                                    <th class="w-2/12">บริษัทผู้ผลิต</th>
                                    <th class="w-3/12">แพทย์ผู้เสนอ</th>
                                    <th class="w-3/12">สถานะการพิจารณา</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" class="text-center p-4">กำลังโหลดข้อมูล...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTv6yIfVLrXZ76oqef80u3iZbheswq3h-igusVAjNryZYucvVhnXc35I2HDNvEZr-4FYf4rwIu9EHn-/pub?gid=463569560&single=true&output=csv';

        let drugDatabase = [];
        
        function loadAndInitializeApp() {
            Papa.parse(GOOGLE_SHEET_CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                trimHeaders: true,
                complete: function(results) {
                    drugDatabase = results.data.filter(row => row.name && row.name.trim() !== '');
                    renderNav();
                    renderSummaryTable();
                    if (drugDatabase.length > 0) {
                        displayDrugDetails(0);
                        const firstNavItem = document.querySelector('.nav-item');
                        if(firstNavItem) firstNavItem.classList.add('active');
                    } else {
                        document.getElementById('drug-details').innerHTML = '<div class="loader">ไม่พบข้อมูลยา</div>';
                    }
                },
                error: function(error) {
                    console.error('Failed to load or parse drug data:', error);
                    document.getElementById('drug-nav').innerHTML = '<div class="text-center p-4 text-red-400">ไม่สามารถโหลดข้อมูลได้</div>';
                    document.getElementById('drug-details').innerHTML = `<div class="loader text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}</div>`;
                }
            });
        }

        function renderNav() {
            const navContainer = document.getElementById('drug-nav');
            navContainer.innerHTML = '';
            drugDatabase.forEach((drug, index) => {
                const navItem = document.createElement('a');
                navItem.href = '#';
                navItem.className = 'block p-3 rounded-md nav-item hover:bg-[#003566] hover:text-white break-words opacity-100 sidebar-text transition-opacity duration-200 text-sm';
                navItem.textContent = drug.name || `รายการที่ ${index + 1}`;
                navItem.onclick = (e) => {
                    e.preventDefault();
                    switchView('details');
                    displayDrugDetails(index);
                    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                    navItem.classList.add('active');
                };
                navContainer.appendChild(navItem);
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('sidebar-toggle');
            toggleButton.addEventListener('click', () => {
                sidebar.classList.toggle('w-20');
                sidebar.classList.toggle('w-72');
                const textElements = document.querySelectorAll('.sidebar-text');
                textElements.forEach(el => {
                    el.classList.toggle('opacity-0');
                    el.classList.toggle('opacity-100');
                });
            });

            loadAndInitializeApp();
            document.getElementById('details-view-btn').onclick = () => switchView('details');
            document.getElementById('table-view-btn').onclick = () => switchView('table');
            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
        });
        
        function renderSummaryTable() {
            const tableBody = document.querySelector('#summary-table tbody');
            tableBody.innerHTML = '';

            if (drugDatabase.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">ไม่พบข้อมูล</td></tr>';
                return;
            }

            const decisionMap = {
                'approve': 'เสนอรับเข้าบัญชี',
                'approve_nonstock': 'เสนอรับ (Non-Stock)',
                'reject': 'เสนอไม่รับเข้าบัญชี',
                '': 'ยังไม่พิจารณา'
            };

            const decisionClassMap = {
                'approve': 'text-green-700 font-semibold',
                'approve_nonstock': 'text-blue-700 font-semibold',
                'reject': 'text-red-700 font-semibold',
                '': 'text-gray-500'
            };

            drugDatabase.forEach((drug, index) => {
                const physicianHtml = (drug.proposingPhysician || '')
                    .split('\n')
                    .map(s => s.trim())
                    .filter(Boolean)
                    .join('<br>');
                
                const decisionKey = drug.pharmacyDecision || '';
                const decisionText = decisionMap[decisionKey];
                const decisionClass = decisionClassMap[decisionKey];

                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${drug.name || '-'}</td>
                        <td>${drug.manufacturer || '-'}</td>
                        <td>${physicianHtml || '-'}</td>
                        <td><span class="${decisionClass}">${decisionText}</span></td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
        
        function renderDecisionSummary() {
            const summaryContainer = document.getElementById('decision-summary-container');
            if (!summaryContainer) return;

            const counts = {
                approve: 0,
                approve_nonstock: 0,
                reject: 0,
                undecided: 0
            };

            drugDatabase.forEach(drug => {
                switch (drug.pharmacyDecision) {
                    case 'approve': counts.approve++; break;
                    case 'approve_nonstock': counts.approve_nonstock++; break;
                    case 'reject': counts.reject++; break;
                    default: counts.undecided++; break;
                }
            });

            summaryContainer.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="bg-green-100 p-4 rounded-lg"><div class="text-4xl font-bold text-green-700">${counts.approve}</div><div class="text-green-800 font-semibold">เสนอรับเข้าบัญชี</div></div>
                    <div class="bg-blue-100 p-4 rounded-lg"><div class="text-4xl font-bold text-blue-700">${counts.approve_nonstock}</div><div class="text-blue-800 font-semibold">เสนอรับ (Non-Stock)</div></div>
                    <div class="bg-red-100 p-4 rounded-lg"><div class="text-4xl font-bold text-red-700">${counts.reject}</div><div class="text-red-800 font-semibold">เสนอไม่รับเข้าบัญชี</div></div>
                    <div class="bg-gray-200 p-4 rounded-lg"><div class="text-4xl font-bold text-gray-700">${counts.undecided}</div><div class="text-gray-800 font-semibold">ยังไม่พิจารณา</div></div>
                </div>
            `;
        }

        function switchView(view) {
            const detailsView = document.getElementById('drug-details-view');
            const tableView = document.getElementById('summary-table-view');
            const detailsBtn = document.getElementById('details-view-btn');
            const tableBtn = document.getElementById('table-view-btn');
            const sidebar = document.getElementById('sidebar');
            const stickyHeader = document.getElementById('sticky-drug-header');

            if (view === 'details') {
                detailsView.classList.remove('hidden');
                tableView.classList.add('hidden');
                detailsBtn.classList.add('active');
                tableBtn.classList.remove('active');
                sidebar.classList.remove('hidden');
                stickyHeader.classList.remove('hidden');
            } else {
                detailsView.classList.add('hidden');
                tableView.classList.remove('hidden');
                detailsBtn.classList.remove('active');
                tableBtn.classList.add('active');
                sidebar.classList.add('hidden');
                stickyHeader.classList.add('hidden');
                renderDecisionSummary();
                renderSummaryTable();
            }
        }
        
        function renderList(text) {
            if (!text || typeof text !== 'string') return '<li>-</li>';
            const items = text.split('\n').map(s => s.trim()).filter(Boolean);
            if (items.length === 0) return '<li>-</li>';
            return items.map(s => `<li>${s}</li>`).join('');
        }
        
        // *** START CHANGE: New function to format reimbursement text color ***
        function formatCompetitorReimbursement(status) {
            if (!status || typeof status !== 'string' || status.trim() === '') {
                return '-';
            }
            const s = status.trim();

            if (s === 'เบิกไม่ได้' || s === 'OCPA Co-pay') {
                return `<span class="text-red-600 font-bold">${s}</span>`;
            }
            if (s === 'OCPA' || s === 'เบิกได้' || === 'เบิกได้ ตามเงื่อนไข' ) {
                return `<span class="text-green-600 font-bold">${s}</span>`;
            }
            if (s === 'สำรองจ่าย') {
                return `<span class="text-blue-600 font-bold">${s}</span>`;
            }
            
            return s; // Return text as-is if no rule matches
        }
        // *** END CHANGE ***

        function renderCompetitorTable(drug) {
            let competitors = [];
            for (let i = 1; i <= 5; i++) {
                const name = drug[`competitor${i}_name`];
                if (name && name.trim() !== '') {
                    competitors.push({
                        name: name,
                        reimbursement: drug[`competitor${i}_reimbursement`] || '-',
                        price: drug[`competitor${i}_price`] || '-',
                        usage: drug[`competitor${i}_usage`] || '-',
                    });
                }
            }

            let tableHtml = `<div class="overflow-x-auto p-2"><table class="w-full text-left border-collapse text-xl"><thead><tr class="border-b-2 border-slate-300 bg-slate-100"><th class="p-3 font-semibold text-slate-700 w-2/5">รายการยา</th><th class="p-3 font-semibold text-slate-700">การเบิกจ่าย</th><th class="p-3 font-semibold text-slate-700">ราคาขายต่อรอบการรักษา/ต่อเดือน</th><th class="p-3 font-semibold text-slate-700">จำนวนเคสที่ใช้ยา</th></tr></thead><tbody>`;
            
            // *** START CHANGE: Apply color formatting to proposed drug's reimbursement ***
            const currentDrugReimbursement = formatCompetitorReimbursement(drug.govReimburse);
            const currentDrugPrice = drug.cyclePrice || drug.monthlyPrice || drug.salePrice || '-';
            tableHtml += `<tr class="border-b border-slate-200 bg-blue-50"><td class="p-3 font-bold text-blue-800">${drug.name || '-'} <span class="font-normal text-sm">(ยาเสนอใหม่)</span></td><td class="p-3">${currentDrugReimbursement}</td><td class="p-3 font-bold">${currentDrugPrice}</td><td class="p-3">-</td></tr>`;
            // *** END CHANGE ***

            if (competitors.length > 0) {
                competitors.forEach(comp => {
                    // *** START CHANGE: Apply color formatting to competitor's reimbursement ***
                    const formattedReimbursement = formatCompetitorReimbursement(comp.reimbursement);
                    tableHtml += `<tr class="border-b border-slate-200 hover:bg-slate-50"><td class="p-3">${comp.name}</td><td class="p-3">${formattedReimbursement}</td><td class="p-3">${comp.price}</td><td class="p-3">${comp.usage}</td></tr>`;
                    // *** END CHANGE ***
                });
            } else {
                 if(drug.competitor && drug.competitor.trim() !== '' && drug.competitor.trim().toLowerCase() !== 'ไม่มี') {
                    tableHtml += `<tr><td colspan="4" class="p-4 text-slate-500 italic">ข้อมูลยาเปรียบเทียบ (เดิม): ${drug.competitor}</td></tr>`
                } else {
                    tableHtml += `<tr><td colspan="4" class="p-4 text-center text-slate-500">ไม่มียาใกล้เคียงในบัญชีโรงพยาบาล</td></tr>`
                }
            }
            tableHtml += `</tbody></table></div>`;
            return tableHtml;
        }

        function getReimbursementClass(status) {
            if (!status) return 'reimburse-no';
            const s = status.toLowerCase().trim();
            if (s === 'เบิกไม่ได้' || s.includes('co-pay')) return 'reimburse-no';
            if (s === 'สำรองจ่าย') return 'reimburse-advance';
            if (s === 'เบิกได้' || s === 'ocpa') return 'reimburse-yes';
            return 'reimburse-yes'; 
        }

        function displayDrugDetails(index) {
            if (index >= drugDatabase.length) return;
            const drug = drugDatabase[index];
            const detailsContainer = document.getElementById('drug-details');
            const stickyHeader = document.getElementById('sticky-drug-header');

            stickyHeader.style.opacity = '0';
            detailsContainer.style.opacity = '0';

            setTimeout(() => {
                const accountColorClass = drug.account === 'NED' ? 'text-red-600' : (drug.account === 'ED' ? 'text-green-600' : 'text-blue-800');
                const hasImage1 = drug.imageUrl && drug.imageUrl.trim() !== '';
                const hasImage2 = drug.imageUrl2 && drug.imageUrl2.trim() !== '';
                let imagesHtml;
                const imageContainerClasses = "w-full h-72 bg-gray-200 rounded-md flex items-center justify-center overflow-hidden";
                const imageClasses = "w-full h-full object-contain";
                const placeholderUrl = "https://placehold.co/400x225/e2e8f0/adb5bd?text=No+Image";
                if (hasImage1 && hasImage2) {
                    imagesHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="${imageContainerClasses}"><img src="${drug.imageUrl}" alt="รูปภาพผลิตภัณฑ์ 1" class="${imageClasses}"></div><div class="${imageContainerClasses}"><img src="${drug.imageUrl2}" alt="รูปภาพผลิตภัณฑ์ 2" class="${imageClasses}"></div></div>`;
                } else if (hasImage1) {
                    imagesHtml = `<div class="${imageContainerClasses}"><img src="${drug.imageUrl}" alt="รูปภาพผลิตภัณฑ์" class="${imageClasses}"></div>`;
                } else if (hasImage2) {
                    imagesHtml = `<div class="${imageContainerClasses}"><img src="${drug.imageUrl2}" alt="รูปภาพผลิตภัณฑ์" class="${imageClasses}"></div>`;
                } else {
                    imagesHtml = `<div class="${imageContainerClasses}"><img src="${placeholderUrl}" alt="ไม่มีรูปภาพ" class="${imageClasses}"></div>`;
                }

                const papFullHtml = (drug.papFull || '').replace(/\n/g, '<br>');
                const proposalHtml = (drug.proposal || '').replace(/\n/g, '<br>');
                const currentDecision = drug.pharmacyDecision || '';
                
                let extraPricesHtml = '';
                if (drug.cyclePrice) extraPricesHtml += `<div class="bg-purple-50 rounded-md p-3"><span class="label">ราคาขายต่อรอบการรักษา</span><span class="value text-lg font-bold text-purple-600">${drug.cyclePrice}</span></div>`;
                if (drug.monthlyPrice) extraPricesHtml += `<div class="bg-sky-50 rounded-md p-3"><span class="label">ราคาขาย (เดือน)</span><span class="value text-lg font-bold text-sky-600">${drug.monthlyPrice}</span></div>`;
                
                let specialNoteHtml = '';
                if (drug.specialNote && drug.specialNote.trim() !== '') {
                    const noteContent = drug.specialNote.replace(/\n/g, '<br>');
                    specialNoteHtml = `<div class="info-card border-t-4 border-red-500"><div class="info-header bg-red-600"><i class="fa-solid fa-triangle-exclamation"></i><span>ปัญหาที่พบ</span></div><div class="p-4"><p class="text-xl font-bold text-red-700">${noteContent}</p></div></div>`;
                }

                let papBlockHtml = '';
                if (drug.pap && drug.pap.trim().toLowerCase() !== 'ไม่มี') {
                    papBlockHtml = `
                        <div class="pt-4 mt-4 border-t-2 border-amber-300">
                            <span class="label flex items-center font-bold text-amber-700">
                                <i class="fa-solid fa-hand-holding-medical mr-2"></i>โครงการช่วยเหลือผู้ป่วย (PAP)
                            </span>
                            <p class="value font-semibold text-lg text-gray-800">${papFullHtml || '-'}</p>
                        </div>`;
                }

                stickyHeader.innerHTML = `<div class="bg-white/80 backdrop-blur-sm p-4 rounded-lg shadow-md mb-6"><h2 class="text-2xl font-bold text-slate-800">${drug.name || '-'}</h2></div>`;
                detailsContainer.innerHTML = `
                <div class="space-y-6">
                    <div class="info-card">
                        <div class="info-header bg-[#03045e]"><i class="fa-solid fa-pills"></i><span>ข้อมูลทั่วไปและราคา</span></div>
                        <div class="p-4 grid grid-cols-1 md:grid-cols-12 gap-6">
                            <div class="md:col-span-7 space-y-4">
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <div class="bg-slate-50 rounded-md p-3"><span class="label">ความแรง</span><span class="value font-semibold">${drug.strength || '-'}</span></div>
                                    <div class="bg-slate-50 rounded-md p-3"><span class="label">รูปแบบยา</span><span class="value">${drug.form || '-'}</span></div>
                                    <div class="bg-slate-50 rounded-md p-3"><span class="label">ขนาดบรรจุ</span><span class="value">${drug.packSize || '-'}</span></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-slate-50 rounded-md p-3"><span class="label">ราคาขาย</span><span class="value text-lg font-bold text-green-600">${drug.salePrice || '-'} ${drug.baseUnit ? ` / ${drug.baseUnit}` : ''}</span></div>
                                    <div class="bg-slate-50 rounded-md p-3"><span class="label">ราคาทุน</span><span class="value text-lg font-bold text-orange-600">${drug.costPrice || '-'} ${drug.baseUnit ? ` / ${drug.baseUnit}` : ''}</span></div>
                                </div>
                                ${extraPricesHtml ? `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${extraPricesHtml}</div>` : ''}
                                
                                ${papBlockHtml}

                                <div>
                                    <h3 class="font-semibold text-lg mb-2 text-[#001d3d]">การเบิกจ่าย</h3>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                        <div class="bg-slate-50 rounded-md p-3 text-center"><span class="label">กรมบัญชีกลาง</span><span class="${getReimbursementClass(drug.govReimburse)}">${drug.govReimburse || '-'}</span></div>
                                        <div class="bg-slate-50 rounded-md p-3 text-center"><span class="label">ประกันสังคม</span><span class="${getReimbursementClass(drug.socialSecurity)}">${drug.socialSecurity || '-'}</span></div>
                                        <div class="bg-slate-50 rounded-md p-3 text-center"><span class="label">สปสช.</span><span class="${getReimbursementClass(drug.nhso)}">${drug.nhso || '-'}</span></div>
                                        <div class="bg-slate-50 rounded-md p-3 text-center"><span class="label">ใน/นอก DRG</span><span class="${getReimbursementClass(drug.drg)}">${drug.drg || '-'}</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="md:col-span-5 space-y-4">
                                <div class="bg-slate-50 rounded-md p-3 h-full flex flex-col">
                                    <div class="mb-4"><span class="label">บริษัทผู้ผลิต/จัดจำหน่าย</span><span class="value">${drug.manufacturer || '-'}</span></div>
                                    <div class="mb-4"><span class="label">แพทย์ผู้เสนอ</span><ul class="value list-none m-0 p-0" style="color: #1a202c; font-size: 1.125rem;">${renderList(drug.proposingPhysician)}</ul></div>
                                    <div class="mb-4"><span class="label">บัญชียา</span><span class="value font-bold text-xl ${accountColorClass}">${drug.account || '-'}</span></div>
                                    <div class="mt-4"><span class="label">ข้อบ่งชี้</span><ul class="value list-disc list-inside mt-1" style="font-size: 1.125rem;">${renderList(drug.indications)}</ul></div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 pt-0"><span class="label">รูปภาพผลิตภัณฑ์</span><div class="mt-2">${imagesHtml}</div></div>
                    </div>
                    
                    ${specialNoteHtml}
                    <div class="info-card"><div class="info-header bg-green-700"><i class="fa-solid fa-user-doctor"></i><span>เหตุผลของแพทย์ผู้เสนอ</span></div><div class="p-4"><ul class="list-disc list-inside text-xl font-bold">${renderList(drug.physicianReason)}</ul></div></div>
                    <div class="info-card"><div class="info-header bg-[#5a189a]"><i class="fa-solid fa-code-compare"></i><span>ยาใกล้เคียงในบัญชี</span></div>${renderCompetitorTable(drug)}</div>
                    <div class="info-card"><div class="info-header bg-gray-600"><i class="fa-solid fa-hospital"></i><span>รพ.โรงเรียนแพทย์ที่มียาในบัญชี</span></div><div class="p-4"><ul class="list-disc list-inside text-xl font-bold columns-1 md:columns-2">${renderList(drug.hospitals)}</ul></div></div>
                    <div class="info-card"><div class="info-header bg-[#0077b6]"><i class="fa-solid fa-clipboard-check"></i><span>ข้อเสนอฝ่ายเภสัชกรรม</span></div><div class="p-4"><p class="text-3xl font-bold">${proposalHtml || '-'}</p></div></div>
                    <div class="info-card"><div class="info-header bg-[#c9184a]"><i class="fa-solid fa-gavel"></i><span>สถานะการพิจารณา</span></div><div class="p-4"><select id="pharmacy-decision-${index}" class="w-full mt-2 p-3 border border-gray-300 rounded-lg text-2xl bg-gray-50 focus:ring-blue-500 focus:border-blue-500"><option value="" disabled ${currentDecision === '' ? 'selected' : ''}>--- กรุณาเลือกสถานะ ---</option><option value="approve" ${currentDecision === 'approve' ? 'selected' : ''}>เสนอรับเข้าบัญชี</option><option value="approve_nonstock" ${currentDecision === 'approve_nonstock' ? 'selected' : ''}>เสนอรับเข้าบัญชี ไม่สำรองคงคลัง (Non-stock)</option><option value="reject" ${currentDecision === 'reject' ? 'selected' : ''}>เสนอไม่รับเข้าบัญชี</option></select></div></div>
                </div>`;
                detailsContainer.style.opacity = '1';
                stickyHeader.style.opacity = '1';
                const decisionDropdown = document.getElementById(`pharmacy-decision-${index}`);
                if (decisionDropdown) {
                    decisionDropdown.onchange = (e) => { drugDatabase[index].pharmacyDecision = e.target.value; };
                }
            }, 150);
        }

        function exportToExcel() {
            if (drugDatabase.length === 0) { alert('ไม่มีข้อมูลสำหรับ Export'); return; }
            const decisionMap = { 'approve': 'เสนอรับเข้าบัญชี', 'approve_nonstock': 'เสนอรับเข้าบัญชี (Non-stock)', 'reject': 'เสนอไม่รับเข้าบัญชี', '': 'ยังไม่พิจารณา' };
            const exportData = drugDatabase.map((drug, index) => {
                const physicianText = (drug.proposingPhysician || '').split('\n').map(s => s.trim()).filter(Boolean).join(', ');
                return { 'ลำดับ': index + 1, 'รายการยา': drug.name || '-', 'บริษัทผู้ผลิต': drug.manufacturer || '-', 'แพทย์ผู้เสนอ': physicianText || '-', 'สถานะการพิจารณา': decisionMap[drug.pharmacyDecision || ''] };
            });
            const ws = XLSX.utils.json_to_sheet(exportData);
            ws['!cols'] = [ { wch: 5 }, { wch: 90 }, { wch: 44 }, { wch: 55 }, { wch: 35 } ];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'สรุปรายการยา');
            XLSX.writeFile(wb, 'สรุปรายการยาเสนอเข้าใหม่-มิย68.xlsx');
        }
    </script>
</body>
</html>
