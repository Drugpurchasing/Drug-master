<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ฐานข้อมูลยารายการ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f4f7f9;
        }
        .main-content {
            transition: opacity 0.3s ease-in-out;
        }
        .nav-item {
            transition: all 0.2s ease;
        }
        .nav-item.active {
            background-color: #0077b6;
            color: white;
            border-right: 4px solid #fbaf00;
        }
        .info-card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .info-header {
            color: white;
            padding: 0.75rem 1.25rem;
            font-weight: 700;
            font-size: 1.125rem;
            display: flex;
            align-items: center;
        }
        .info-header .fa-solid {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }
        
        .label {
            font-weight: 600;
            color: #4a5568;
            display: block;
            font-size: 0.875rem;
        }
        .value {
            color: #1a202c;
            font-size: 1.125rem; /* Increased font size */
        }
        .reimburse-no {
            color: #d90429;
            font-weight: 700;
            background-color: #fee2e2;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            display: inline-block;
        }
        .reimburse-yes {
             color: #028a0f;
            font-weight: 700;
            background-color: #dcfce7;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            display: inline-block;
        }
        .pap-card {
            border-top: 4px solid #fbaf00;
        }
        .view-switcher {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #e2e8f0;
            border-radius: 8px;
        }
        .view-switcher-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            background-color: transparent;
            color: #475569;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .view-switcher-btn.active {
            background-color: #ffffff;
            color: #0077b6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #summary-table th {
            background-color: #f1f5f9;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #1e293b;
        }
         #summary-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
         }
         #summary-table tbody tr:hover {
            background-color: #f8fafc;
         }
        #sticky-drug-header {
            position: sticky;
            top: 0;
            z-index: 10;
            transition: opacity 0.3s ease-in-out;
        }
        .loader {
            text-align: center;
            padding: 2rem;
            font-size: 1.25rem;
            color: #475569;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <aside id="sidebar" class="w-72 bg-[#001d3d] text-gray-200 flex-shrink-0">
            <div class="p-4 text-center border-b border-gray-700">
                <h1 class="text-xl font-bold text-white">รายการยาใหม่</h1>
            </div>
            <nav id="drug-nav" class="p-2 space-y-1">
                 <div class="text-center p-4 text-gray-400">กำลังโหลดข้อมูล...</div>
            </nav>
        </aside>

        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            <div class="view-switcher">
                <button id="details-view-btn" class="view-switcher-btn active">รายละเอียดยา</button>
                <button id="table-view-btn" class="view-switcher-btn">ตารางสรุป</button>
            </div>

            <div id="drug-details-view">
                <div id="sticky-drug-header" class="opacity-0"></div>
                <div id="drug-details" class="main-content opacity-100">
                    <div class="loader">กำลังโหลดข้อมูลยา...</div>
                </div>
            </div>

            <div id="summary-table-view" class="hidden">
                 <div class="info-card">
                    <div class="info-header bg-[#03045e]">
                         <i class="fa-solid fa-table-list"></i>
                        <span>ตารางสรุปรายการยาทั้งหมด</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="summary-table" class="w-full text-sm">
                            <thead>
                                <tr>
                                    <th>ลำดับ</th>
                                    <th>รายการยา</th>
                                    <th>ความแรง</th>
                                    <th>รูปแบบยา</th>
                                    <th>บริษัทผู้ผลิต</th>
                                    <th>แพทย์ผู้เสนอ</th>
                                </tr>
                            </thead>
                            <tbody>
                                 <tr><td colspan="6" class="text-center p-4">กำลังโหลดข้อมูล...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // URL for the published Google Sheet as CSV
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTv6yIfVLrXZ76oqef80u3iZbheswq3h-igusVAjNryZYucvVhnXc35I2HDNvEZr-4FYf4rwIu9EHn-/pub?gid=463569560&single=true&output=csv';

        // Global variable to hold the fetched data
        let drugDatabase = [];

        /**
         * Parses CSV text into an array of objects.
         * @param {string} csvText - The CSV data as a string.
         * @returns {Array<Object>} - An array of drug data objects.
         */
        /**
 * Parses CSV text into an array of objects robustly.
 * This version correctly handles commas and quotes within fields.
 * @param {string} csvText - The CSV data as a string.
 * @returns {Array<Object>} - An array of drug data objects.
 */
function parseCsv(csvText) {
    const lines = csvText.trim().split('\n');
    if (lines.length < 2) return [];

    // Extract headers from the first line
    const headers = lines[0].trim().split(',').map(h => h.trim());
    const data = [];

    // Regex to properly match CSV fields, handling quoted values containing commas
    const csvRegex = /("((?:[^"]|"")*)"|([^,]*))(,|$)/g;

    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue; // Skip empty lines

        const values = [];
        let match;
        // Reset regex state for each line
        csvRegex.lastIndex = 0; 
        
        while (match = csvRegex.exec(line)) {
            let value = match[2] !== undefined ? match[2].replace(/""/g, '"') : match[3];
            values.push(value.trim());

            if (match[4] === '') {
                 // Handles case where line ends without a comma
                 // and ensures we capture all fields even if some are empty at the end.
                 let remainingFields = headers.length - values.length;
                 while(csvRegex.lastIndex === line.length && remainingFields > 0) {
                     values.push('');
                     remainingFields--;
                 }
                 break;
            }
        }

        const entry = {};
        headers.forEach((header, j) => {
            let value = values[j] || ''; // Use empty string for missing values

            if (header === 'salePrice' || header === 'costPrice') {
                entry[header] = parseFloat(value) || 0;
            } else if (header === 'hospitals') {
                entry[header] = value.split(';').map(h => h.trim()).filter(h => h);
            } else {
                entry[header] = value;
            }
        });
        data.push(entry);
    }
    return data;
}

        /**
         * Fetches and processes drug data from the Google Sheet.
         */
        async function loadAndInitializeApp() {
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                const csvText = await response.text();
                drugDatabase = parseCsv(csvText);
                
                // Once data is loaded, render everything
                renderNav();
                renderSummaryTable();
                if (drugDatabase.length > 0) {
                    displayDrugDetails(0);
                    document.querySelector('.nav-item').classList.add('active');
                } else {
                     document.getElementById('drug-details').innerHTML = '<div class="loader">ไม่พบข้อมูลยา</div>';
                }
            } catch (error) {
                console.error('Failed to load drug data:', error);
                document.getElementById('drug-nav').innerHTML = '<div class="text-center p-4 text-red-400">ไม่สามารถโหลดข้อมูลได้</div>';
                document.getElementById('drug-details').innerHTML = '<div class="loader text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูลยา</div>';
            }
        }

        function renderNav() {
            const navContainer = document.getElementById('drug-nav');
            navContainer.innerHTML = ''; // Clear loader
            drugDatabase.forEach((drug, index) => {
                const navItem = document.createElement('a');
                navItem.href = '#';
                navItem.className = 'block p-3 rounded-md nav-item hover:bg-[#003566] hover:text-white';
                navItem.textContent = drug.name;
                navItem.onclick = (e) => {
                    e.preventDefault();
                    switchView('details');
                    displayDrugDetails(index);
                    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                    navItem.classList.add('active');
                };
                navContainer.appendChild(navItem);
            });
        }
        
        function renderSummaryTable() {
            const tableBody = document.querySelector('#summary-table tbody');
            tableBody.innerHTML = ''; // Clear loader
            if(drugDatabase.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">ไม่พบข้อมูล</td></tr>';
                return;
            }
            drugDatabase.forEach((drug, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${drug.name}</td>
                        <td>${drug.strength}</td>
                        <td>${drug.form}</td>
                        <td>${drug.manufacturer}</td>
                        <td>${drug.proposingPhysician}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function switchView(view) {
            const detailsView = document.getElementById('drug-details-view');
            const tableView = document.getElementById('summary-table-view');
            const detailsBtn = document.getElementById('details-view-btn');
            const tableBtn = document.getElementById('table-view-btn');
            const sidebar = document.getElementById('sidebar');
            const stickyHeader = document.getElementById('sticky-drug-header');

            if (view === 'details') {
                detailsView.classList.remove('hidden');
                tableView.classList.add('hidden');
                detailsBtn.classList.add('active');
                tableBtn.classList.remove('active');
                sidebar.classList.remove('hidden');
                stickyHeader.classList.remove('hidden');
            } else {
                detailsView.classList.add('hidden');
                tableView.classList.remove('hidden');
                detailsBtn.classList.remove('active');
                tableBtn.classList.add('active');
                sidebar.classList.add('hidden');
                stickyHeader.classList.add('hidden');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadAndInitializeApp();
            document.getElementById('details-view-btn').onclick = () => switchView('details');
            document.getElementById('table-view-btn').onclick = () => switchView('table');
        });

        function displayDrugDetails(index) {
    if (index >= drugDatabase.length) return;
    const drug = drugDatabase[index];
    const detailsContainer = document.getElementById('drug-details');
    const stickyHeader = document.getElementById('sticky-drug-header');
    
    stickyHeader.style.opacity = '0';
    detailsContainer.style.opacity = '0';

    setTimeout(() => {
        const accountColorClass = drug.account === 'NED' ? 'text-red-600' : (drug.account === 'ED' ? 'text-green-600' : 'text-blue-800');

        // ฟิลด์ที่รองรับขึ้นบรรทัดใหม่
        const hospitalsHtml = (drug.hospitals && typeof drug.hospitals === 'string')
            ? drug.hospitals.split(/\n|;/).filter(h => h.trim()).map(h => `<li>${h.trim()}</li>`).join('')
            : (Array.isArray(drug.hospitals) ? drug.hospitals.filter(h => h.trim()).map(h => `<li>${h.trim()}</li>`).join('') : '');

        const physicianReasonHtml = (drug.physicianReason || '').replace(/\n/g, '<br>');
        const competitorHtml = (drug.competitor || '').replace(/\n/g, '<br>');
        const proposalHtml = (drug.proposal || '').replace(/\n/g, '<br>');
        const papFullHtml = (drug.papFull || '').replace(/\n/g, '<br>');

        stickyHeader.innerHTML = `
            <div class="bg-white/80 backdrop-blur-sm p-4 rounded-lg shadow-md mb-6">
                <h2 class="text-2xl font-bold text-slate-800">${drug.name || '-'}</h2>
            </div>
        `;

        detailsContainer.innerHTML = `
        <div class="space-y-6">
            <!-- CARD 1: Main Info -->
            <div class="info-card">
                <div class="info-header bg-[#03045e]">
                    <i class="fa-solid fa-pills"></i>
                    <span>ข้อมูลทั่วไปและราคา</span>
                </div>
                <div class="p-4 grid grid-cols-1 md:grid-cols-12 gap-6">
                    <div class="md:col-span-7 space-y-4">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="bg-slate-50 rounded-md p-3"><span class="label">ความแรง</span><span class="value font-semibold">${drug.strength || '-'}</span></div>
                            <div class="bg-slate-50 rounded-md p-3"><span class="label">รูปแบบยา</span><span class="value">${drug.form || '-'}</span></div>
                            <div class="bg-slate-50 rounded-md p-3"><span class="label">ขนาดบรรจุ</span><span class="value">${drug.packSize || '-'}</span></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-50 rounded-md p-3"><span class="label">ราคาขาย (หน่วยย่อย)</span><span class="value text-lg font-bold text-green-600">${drug.salePrice ? drug.salePrice.toLocaleString('th-TH', { style: 'currency', currency: 'THB' }) : '-'}</span></div>
                            <div class="bg-slate-50 rounded-md p-3"><span class="label">ราคาทุน (หน่วยย่อย)</span><span class="value text-lg font-bold text-orange-600">${drug.costPrice ? drug.costPrice.toLocaleString('th-TH', { style: 'currency', currency: 'THB' }) : '-'}</span></div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg mb-2 text-[#001d3d]">สถานะการเบิกจ่าย</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <div class="bg-slate-50 rounded-md p-3 text-center"><span class="label">กรมบัญชีกลาง</span><span class="${drug.govReimburse && drug.govReimburse.toLowerCase() !== 'เบิกไม่ได้' ? 'reimburse-yes' : 'reimburse-no'}">${drug.govReimburse || '-'}</span></div>
                                <div class="bg-slate-50 rounded-md p-3 text-center"><span class="label">ประกันสังคม</span><span class="${drug.socialSecurity && drug.socialSecurity.toLowerCase() !== 'เบิกไม่ได้' ? 'reimburse-yes' : 'reimburse-no'}">${drug.socialSecurity || '-'}</span></div>
                                <div class="bg-slate-50 rounded-md p-3 text-center"><span class="label">สปสช.</span><span class="${drug.nhso && drug.nhso.toLowerCase() !== 'เบิกไม่ได้' ? 'reimburse-yes' : 'reimburse-no'}">${drug.nhso || '-'}</span></div>
                                <div class="bg-slate-50 rounded-md p-3 text-center"><span class="label">ใน/นอก DRG</span><span class="${drug.drg && drug.drg.toLowerCase() !== 'เบิกไม่ได้' ? 'reimburse-yes' : 'reimburse-no'}">${drug.drg || '-'}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-5 space-y-4">
                        <div class="bg-slate-50 rounded-md p-3 h-full flex flex-col">
                            <div class="mb-4"><span class="label">บริษัทผู้ผลิต/จัดจำหน่าย</span><span class="value">${drug.manufacturer || '-'}</span></div>
                            <div class="mb-4"><span class="label">แพทย์ผู้เสนอ</span><span class="value">${drug.proposingPhysician || '-'}</span></div>
                            <div class="mb-4"><span class="label">บัญชียา</span><span class="value font-bold text-xl ${accountColorClass}">${drug.account || '-'}</span></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 pt-0">
                    <span class="label">รูปภาพผลิตภัณฑ์</span>
                    <div class="mt-1 w-full h-72 bg-gray-200 rounded-md flex items-center justify-center overflow-hidden">
                        <img src="${drug.imageUrl || 'https://placehold.co/400x225/e2e8f0/adb5bd?text=No+Image'}" alt="รูปภาพผลิตภัณฑ์ ${drug.name || ''}" class="w-full h-full object-contain">
                    </div>
                </div>
            </div>

            <!-- CARD: Physician's Reason -->
            <div class="info-card">
                <div class="info-header bg-green-700"><i class="fa-solid fa-user-doctor"></i><span>เหตุผลของแพทย์ผู้เสนอ</span></div>
                <div class="p-4"><p class="text-xl font-bold">${physicianReasonHtml || '-'}</p></div>
            </div>

            <!-- CARD: Competitor -->
            <div class="info-card">
                <div class="info-header bg-[#5a189a]"><i class="fa-solid fa-code-compare"></i><span>ยาใกล้เคียงในบัญชี</span></div>
                <div class="p-4"><p class="text-xl font-bold">${competitorHtml || '-'}</p></div>
            </div>

            <!-- CARD: Hospitals -->
            <div class="info-card">
                <div class="info-header bg-gray-600"><i class="fa-solid fa-hospital"></i><span>โรงพยาบาลโรงเรียนแพทย์ที่มียา</span></div>
                <div class="p-4"><ul class="list-disc list-inside text-xl font-bold columns-1 md:columns-2">${hospitalsHtml || '<li>-</li>'}</ul></div>
            </div>

            <!-- CARD: PAP -->
            ${drug.pap && drug.pap !== 'ไม่มี' ? `
            <div class="info-card pap-card">
                <div class="info-header bg-[#fbaf00] text-gray-800"><i class="fa-solid fa-hand-holding-medical"></i><span>โครงการช่วยเหลือผู้ป่วย (PAP)</span></div>
                <div class="p-4"><p class="text-xl font-bold">${papFullHtml || '-'}</p></div>
            </div>` : ''}
            
            <!-- CARD: Proposal (Last) -->
            <div class="info-card">
                <div class="info-header bg-[#0077b6]"><i class="fa-solid fa-clipboard-check"></i><span>ข้อเสนอฝ่ายเภสัชกรรม</span></div>
                <div class="p-4"><p class="text-3xl font-bold">${proposalHtml || '-'}</p></div>
            </div>
        </div>
        `;
        detailsContainer.style.opacity = '1';
        stickyHeader.style.opacity = '1';
    }, 150);
}

    </script>

</body>
</html>
