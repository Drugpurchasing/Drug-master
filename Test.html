<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infographic สรุปข้อมูลยา (เชื่อมต่อ Google Sheet)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .card-category { border-left: 4px solid; }
        .category-gi { border-color: #34D399; }
        .category-transplant { border-color: #60A5FA; }
        .category-renal { border-color: #FBBF24; }
        .category-cardio { border-color: #F87171; }
        .category-diabetes { border-color: #A78BFA; }
        .category-neuro { border-color: #F472B6; }
        .category-hema-onco { border-color: #FB923C; }
        .category-pulmonary { border-color: #2DD4BF; }
        .category-iv { border-color: #93C5FD; }
        .category-misc { border-color: #A3A3A3; }
        .category-obgyn { border-color: #F0ABFC; }
        .category-ophtha { border-color: #7DD3FC; }
        .category-vaccine { border-color: #818CF8; }

        .category-tag {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
        }
        .tag-gi { background-color: #34D399; }
        .tag-transplant { background-color: #60A5FA; }
        .tag-renal { background-color: #FBBF24; }
        .tag-cardio { background-color: #F87171; }
        .tag-diabetes { background-color: #A78BFA; }
        .tag-neuro { background-color: #F472B6; }
        .tag-hema-onco { background-color: #FB923C; }
        .tag-pulmonary { background-color: #2DD4BF; }
        .tag-iv { background-color: #93C5FD; }
        .tag-misc { background-color: #A3A3A3; }
        .tag-obgyn { background-color: #F0ABFC; }
        .tag-ophtha { background-color: #7DD3FC; }
        .tag-vaccine { background-color: #818CF8; }

        #loader {
            border: 8px solid #f3f3f3; border-top: 8px solid #3498db;
            border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .truncate-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

<div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-800">สรุปรายการยาใหม่</h1>
        <p class="text-lg text-gray-500 mt-2">Infographic ข้อมูลยาจาก Google Sheet</p>
    </header>

    <!-- Loading indicator -->
    <div id="loading-container" class="flex flex-col items-center justify-center p-10">
        <div id="loader"></div>
        <p class="text-gray-600 mt-4">กำลังโหลดข้อมูลยาจาก Google Sheet...</p>
    </div>
    
    <!-- Drug cards will be dynamically inserted here -->
    <div id="drug-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8"></div>
</div>

<script>
const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTv6yIfVLrXZ76oqef80u3iZbheswq3h-igusVAjNryZYucvVhnXc35I2HDNvEZr-4FYf4rwIu9EHn-/pub?gid=0&single=true&output=csv';

const grid = document.getElementById('drug-grid');
const loadingContainer = document.getElementById('loading-container');

// Fallback for undefined group, tag, color
function safeCode(code) {
    return code && typeof code === "string" ? code.replace(/[^a-zA-Z0-9\-]/g, '').toLowerCase() : 'misc';
}

async function loadDrugData() {
    if (!googleSheetUrl || googleSheetUrl.trim() === '') {
        loadingContainer.innerHTML = '<p class="text-red-600 font-bold text-center">!! ข้อผิดพลาด: กรุณาตั้งค่า URL ของ Google Sheet ในโค้ดก่อน<br>ไปที่ตัวแปร `googleSheetUrl` แล้ววางลิงก์ CSV ที่เผยแพร่จาก Google Sheet ของคุณ</p>';
        return;
    }
    try {
        const response = await fetch(googleSheetUrl);
        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
        const csvText = await response.text();
        Papa.parse(csvText, {
            header: true, skipEmptyLines: true,
            complete: function(results) {
                loadingContainer.style.display = 'none';
                const validDrugData = results.data.filter(row => row.sapCode && row.sapCode.trim() !== '');
                if(validDrugData.length === 0) {
                    grid.innerHTML = '<div class="col-span-1 md:col-span-2 xl:col-span-3 text-center text-red-500 font-semibold">ไม่มีข้อมูลที่จะแสดง กรุณาตรวจสอบชีตหรือรีเฟรช</div>';
                    return;
                }
                renderCards(validDrugData);
            },
            error: function(error) {
                loadingContainer.innerHTML = `<p class="text-red-600 font-bold">ไม่สามารถประมวลผลข้อมูล CSV ได้: ${error.message}</p>`;
            }
        });
    } catch (error) {
        loadingContainer.innerHTML = `<p class="text-red-600 font-bold">ไม่สามารถโหลดข้อมูลได้ ตรวจสอบ URL และการตั้งค่าการเผยแพร่ (Publish to the web): ${error.message}</p>`;
    }
}

function renderCards(drugData) {
    grid.innerHTML = '';
    // Group by group (เช่น GI, Cardio, etc.)
    const drugGroups = drugData.reduce((acc, drug) => {
        const groupName = (drug.group || 'ไม่มีกลุ่ม').trim();
        if (!acc[groupName]) acc[groupName] = [];
        acc[groupName].push(drug);
        return acc;
    }, {});

    // Sort by groupOrder
    const sortedGroupNames = Object.keys(drugGroups).sort((a, b) => {
        const aOrder = parseInt(drugGroups[a][0]?.groupOrder || 99, 10);
        const bOrder = parseInt(drugGroups[b][0]?.groupOrder || 99, 10);
        return aOrder - bOrder;
    });

    sortedGroupNames.forEach(groupName => {
        if(groupName === "ไม่มีกลุ่ม" && drugGroups[groupName].length === 0) return;
        // Section header
        const header = document.createElement('div');
        header.className = 'col-span-1 md:col-span-2 xl:col-span-3 mt-8 mb-4';
        header.innerHTML = `<h2 class="text-3xl font-bold border-b-4 border-gray-300 pb-3 text-gray-700">${groupName}</h2>`;
        grid.appendChild(header);

        // Sort within group by itemOrder
        const drugsInGroup = drugGroups[groupName].sort((a, b) => parseInt(a.itemOrder || 99, 10) - parseInt(b.itemOrder || 99, 10));

        drugsInGroup.forEach((drug, index) => {
            // Safe values
            const code = safeCode(drug.code);
            const imageUrl = (drug.image && drug.image.trim() !== '') ? drug.image : '';
            const stockInfo = drug.stock || '-';
            const unitInfo = drug.unit || '-';
            const proposerInfo = (drug.proposer || '-').replace(/\\n|\n/g, '<br>');
            const notesInfo = (drug.notes || '-').replace(/\\n|\n/g, '<br>');
            const dose = drug.dose || '-';
            const indication = drug.indication || '-';
            const storage = drug.storage || '-';
            const food = drug.food || '-';
            // Card
            const card = document.createElement('div');
            card.className = `bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300 flex flex-col card-category category-${code}`;
            card.innerHTML = `
                <div class="h-48 w-full bg-gray-100 flex items-center justify-center">
                    <img class="max-h-full max-w-full object-contain"
                         src="${imageUrl}"
                         alt="รูปยา ${drug.name || ''}"
                         onerror="this.onerror=null;this.src='https://placehold.co/600x400/E2E8F0/4A5568?text=Image+Not+Found';">
                </div>
                <div class="p-6 flex-grow flex flex-col">
                    <div class="flex justify-between items-start">
                        <div class="w-full pr-2">
                            <div class="flex items-center mb-1">
                                <span class="text-gray-400 font-bold text-lg mr-3">${index + 1}.</span>
                                <p class="text-sm font-semibold text-gray-500">${drug.generic || '-'}</p>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mt-1 ml-6">${drug.name || '-'}</h3>
                            <p class="text-sm text-gray-500 font-mono mt-1 ml-6">รหัสยา: ${drug.sapCode || '-'}</p>
                        </div>
                        <span class="category-tag tag-${code} whitespace-nowrap">${drug.type || '-'}</span>
                    </div>
                    <div class="mt-4 space-y-4 text-sm text-gray-700 overflow-auto">
                        <div class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM8 9a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1zm1 4a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>
                            <div><strong class="font-semibold">หน่วยเบิก:</strong> ${unitInfo}</div>
                        </div>
                        <div class="flex items-start text-blue-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-blue-600 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 4a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V4zm2 2v10h12V6H4zm3 2h6a1 1 0 010 2H7a1 1 0 010-2z" /></svg>
                            <div><strong class="font-semibold">จำนวนที่ควรสต๊อค:</strong> ${stockInfo}</div>
                        </div>
                        <div class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-purple-600 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                            <div><strong class="font-semibold">แพทย์ผู้เสนอ:</strong> ${proposerInfo}</div>
                        </div>
                        <div class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-${code}-500 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                            <div><strong class="font-semibold">ข้อบ่งใช้:</strong> ${indication}</div>
                        </div>
                        <div class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-${code}-500 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" /></svg>
                            <div><strong class="font-semibold">ขนาดใช้ยา:</strong> ${dose}</div>
                        </div>
                        <div class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-${code}-500 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.993.883L4 8v9a1 1 0 001 1h10a1 1 0 001-1V8l-.007-.117A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4z" /></svg>
                            <div><strong class="font-semibold">การจัดเก็บ:</strong> ${storage}</div>
                        </div>
                        <div class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-${code}-500 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 14.95a1 1 0 001.414 1.414l.707-.707a1 1 0 00-1.414-1.414l-.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1zM4.343 5.757a1 1 0 001.414-1.414l-.707-.707a1 1 0 10-1.414 1.414l.707.707z" /></svg>
                            <div><strong class="font-semibold">อาหาร:</strong> ${food}</div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-100 px-6 py-4 border-t border-gray-200">
                    <p class="text-sm text-gray-700" title="${notesInfo.replace(/<br>/g,'\n')}">
                        <strong class="font-semibold text-gray-800">หมายเหตุ:</strong> <span class="truncate-3">${notesInfo}</span>
                    </p>
                </div>
            `;
            grid.appendChild(card);
        });
    });
}

// Initial load
loadDrugData();
</script>
</body>
</html>
