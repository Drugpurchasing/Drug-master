<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <title>Drug master CRA</title>
    <base target="_top">
    <link rel="icon" type="image/png" href="favicon-32x32.png">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://code.jquery.com">

    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1a202c" media="(prefers-color-scheme: dark)">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.2/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    /* WCAG 2.4.7 Focus Visible: Ensure all interactive elements have a clear focus state */
    :focus-visible {
        outline: 3px solid var(--focus-ring-color) !important;
        outline-offset: 2px;
        box-shadow: 0 0 0 4px var(--focus-ring-shadow) !important;
        border-radius: 4px;
    }

    /* Core Requirement: CSS Variables for Theming (Light & Dark Mode) */
    :root {
        --primary-color: #0d6efd;
        --secondary-color: #1a4d8c;
        --accent-color: #ffc107;
        --success-color: #198754;
        --warning-color: #fd7e14;
        --danger-color: #dc3545;
        --info-color: #0dcaf0;
        --purple-color: #6f42c1;

        --bg-color: #f0f2f5;
        --surface-color: #ffffff;
        --text-color: #212529;
        --text-muted-color: #6c757d;
        --border-color: #dee2e6;
        --header-gradient: linear-gradient(135deg, #1a4d8c 0%, #0d6efd 100%);
        --card-shadow: 0 6px 15px rgba(0, 0, 0, 0.07);
        --focus-ring-color: #0d6efd;
        --focus-ring-shadow: rgba(13, 110, 253, 0.25);
    }
    
    /* Core Requirement: Dark Mode Theme */
    [data-theme="dark"] {
        --primary-color: #4dabf7;
        --secondary-color: #a5d8ff;
        --accent-color: #ffd43b;
        --success-color: #40c057;
        --warning-color: #f76707;
        --danger-color: #fa5252;
        --info-color: #3bc9db;
        --purple-color: #da77f2;
        
        --bg-color: #121212;
        --surface-color: #1e1e1e;
        --text-color: #e9ecef;
        --text-muted-color: #adb5bd;
        --border-color: #495057;
        --header-gradient: linear-gradient(135deg, #0b1a2e 0%, #1c3d5e 100%);
        --card-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        --focus-ring-color: #4dabf7;
        --focus-ring-shadow: rgba(77, 171, 247, 0.35);
    }
    
    /* Core Requirement: prefers-reduced-motion for A11y */
    @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
            scroll-behavior: auto !important;
        }
    }

    body {
        font-family: 'Sarabun', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        line-height: 1.6;
        transition: background-color 0.3s, color 0.3s;
        /* Core Requirement: clamp() for responsive typography */
        font-size: clamp(0.9rem, 0.5vw + 0.8rem, 1rem);
    }

    .app-container { max-width: 1800px; margin: 0 auto; padding: 0 1rem; }
    .card { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 25px; }
    .card-header { background: var(--header-gradient); padding: 8px 20px; border-bottom: none; }
    .logo-container { display: flex; align-items: center; justify-content: space-between; background: var(--header-gradient); padding: 1rem 1.5rem; border-radius: 10px; color: white; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .logo-container img { height: 60px; }
    .app-title {
        /* Core Requirement: clamp() for responsive typography */
        font-size: clamp(1.5rem, 1.2vw + 1rem, 2rem);
        font-weight: 700; color: white; margin: 0; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    .version-info { font-size: 0.85rem; color: var(--accent-color); font-weight: 500; background: rgba(0, 0, 0, 0.2); padding: 5px 12px; border-radius: 20px; margin-top: 5px; }
    .filter-section { background-color: var(--surface-color); padding: 1rem 1.25rem; border-radius: 10px; margin-bottom: 1rem; border: 1px solid var(--border-color); }
    .theme-switcher { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
    
    /* DataTable Specific Styles */
    table.dataTable { border-collapse: collapse !important; }
    table.dataTable thead th { background-color: var(--secondary-color); color: white; font-weight: 600; vertical-align: middle; padding: 12px 15px; }
    #drugTable td { vertical-align: middle; padding: 10px 15px; }
    
    /* Responsive DataTables: Style for the child row toggle (+) button */
    table.dataTable.dtr-inline.collapsed>tbody>tr>td.dtr-control::before {
        background-color: var(--primary-color);
        border-color: var(--surface-color);
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    table.dataTable.dtr-inline.collapsed>tbody>tr.parent>td.dtr-control::before {
        background-color: var(--danger-color);
    }

    /* WCAG 1.4.3 Contrast: Ensure badges are readable */
    .badge {
        font-weight: 600; /* Increased for readability */
        padding: 0.6em 0.9em;
        font-size: 0.85rem;
        border-radius: 8px;
    }
    .bg-info.text-dark { background-color: var(--info-color) !important; color: #000 !important; }
    .bg-warning.text-dark { background-color: var(--warning-color) !important; color: #000 !important; }

    /* Modal Styles */
    .modal-content { background-color: var(--surface-color); border-color: var(--border-color); }
    .modal-header { background: var(--header-gradient); color: white; padding: 1rem 1.5rem; }
    .modal-header .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
    .detail-item {
        flex: 1; min-width: 150px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-left: 5px solid var(--primary-color);
        border-radius: 8px; padding: 1rem;
    }
    .detail-item strong { display: block; color: var(--secondary-color); margin-bottom: 8px; font-weight: 700; font-size: 0.9rem; text-transform: uppercase; }
    .drug-image {
        width: 100%;
        /* Performance: aspect-ratio prevents CLS */
        aspect-ratio: 4 / 3;
        object-fit: contain;
        background-color: var(--bg-color);
        border-radius: 10px; border: 1px solid var(--border-color);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .logo-container { flex-direction: column; text-align: center; gap: 1rem; }
    }
</style>
</head>

<body data-theme="light">
    <div class="app-container py-4">
        <header class="logo-container">
            <div class="d-flex align-items-center">
                <img src="CRAlogo.png" alt="CRA Logo" class="img-fluid me-3" onerror="this.style.display='none'">
                <div>
                    <h1 class="app-title">Drug master CRA</h1>
                    <p class="version-info mb-0 fw-bold">Latest update 07/08/2025 | Version 5.0</p>
                </div>
            </div>
            <button class="theme-switcher" id="themeSwitcher" title="Toggle Light/Dark Mode" aria-label="Toggle color theme">
                <i class="fas fa-moon"></i>
            </button>
        </header>
        
        <main class="card">
            <div class="card-header"></div>
            <div class="card-body p-lg-4">
                <div class="filter-section">
                    <div class="row g-3 justify-content-between align-items-center">
                        <div class="col-lg-5 col-md-12">
                             <label for="globalSearch" class="visually-hidden">ค้นหายา (Global Search)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search text-primary"></i></span>
                                <input type="text" id="globalSearch" class="form-control" placeholder="ค้นหายา...">
                            </div>
                        </div>
                        <div class="col-lg-7 col-md-12">
                            <div class="d-flex flex-wrap gap-2 justify-content-md-end justify-content-center">
                                <a href="https://drugpurchasing.github.io/Drug-master/Markup.html" target="_blank" class="btn btn-warning text-dark fw-bold"><i class="fas fa-calculator me-1"></i>Markup</a>
                                <a href="https://drugpurchasing.github.io/Drug-master/NewList.html" target="_blank" class="btn" style="background-color: var(--purple-color); color: white;"><i class="fas fa-file-medical me-1"></i>New Drugs</a>
                                <button id="exportButton" class="btn btn-success"><i class="fas fa-file-excel me-1"></i>Excel</button>
                                <button id="toggleFilterBtn" class="btn btn-info" aria-controls="filterPanel" aria-expanded="false"><i class="fas fa-filter me-1"></i>Groups</button>
                            </div>
                        </div>
                    </div>
                     <div id="filterPanel" class="mt-3" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="drugGroupFilter" class="form-label fw-bold">Filter by Drug Group</label>
                                <div class="d-flex gap-2">
                                    <select id="drugGroupFilter" class="form-select" multiple="multiple" style="width: 100%;"></select>
                                    <button class="btn btn-outline-secondary btn-sm" id="clearGroupFilter" title="Clear Group Filter" aria-label="Clear Drug Group Filter"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="drugSubgroupFilter" class="form-label fw-bold">Filter by Drug Subgroup</label>
                                <div class="d-flex gap-2">
                                    <select id="drugSubgroupFilter" class="form-select" multiple="multiple" style="width: 100%;"></select>
                                    <button class="btn btn-outline-secondary btn-sm" id="clearSubgroupFilter" title="Clear Subgroup Filter" aria-label="Clear Drug Subgroup Filter"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="loadingIndicator" class="progress my-4" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="progressBar">
                        <strong class="text-white" id="progressText">Loading...</strong>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table id="drugTable" class="table table-hover table-striped w-100"></table>
                </div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="drugDetailModal" tabindex="-1" role="dialog" aria-labelledby="drugDetailModalLabel" aria-modal="true" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="drugDetailModalLabel">Drug Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="drugDetailModalBody" tabindex="-1">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js" defer></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js" defer></script>
    <script src="https://cdn.datatables.net/responsive/3.0.2/js/dataTables.responsive.min.js" defer></script>
    <script src="https://cdn.datatables.net/responsive/3.0.2/js/responsive.bootstrap5.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script>
    
<script>
// Wait for the DOM to be ready before executing JS
document.addEventListener("DOMContentLoaded", function() {
    
    // --- Core Requirement: Dark Mode Theming Logic ---
    const themeSwitcher = document.getElementById('themeSwitcher');
    const moonIcon = '<i class="fas fa-moon"></i>';
    const sunIcon = '<i class="fas fa-sun"></i>';
    
    const getStoredTheme = () => localStorage.getItem('theme');
    const setStoredTheme = theme => localStorage.setItem('theme', theme);

    const getPreferredTheme = () => {
        const storedTheme = getStoredTheme();
        if (storedTheme) {
            return storedTheme;
        }
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };

    const setTheme = theme => {
        document.body.setAttribute('data-theme', theme);
        themeSwitcher.innerHTML = theme === 'dark' ? sunIcon : moonIcon;
        // Update meta theme-color for mobile browser chrome
        document.querySelector('meta[name="theme-color"][media="(prefers-color-scheme: light)"]').setAttribute('content', theme === 'dark' ? '#1a202c' : '#ffffff');
        document.querySelector('meta[name="theme-color"][media="(prefers-color-scheme: dark)"]').setAttribute('content', theme === 'dark' ? '#1a202c' : '#ffffff');

    };

    setTheme(getPreferredTheme());
    
    themeSwitcher.addEventListener('click', () => {
        const currentTheme = getStoredTheme() || getPreferredTheme();
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        setStoredTheme(newTheme);
        setTheme(newTheme);
    });
    
    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (!getStoredTheme()) {
            setTheme(getPreferredTheme());
        }
    });

    // --- Application Logic ---
    const webAppUrl = 'https://script.google.com/macros/s/AKfycbzDSIzvndrlTxCT6hxQIxsKosS5PRphOn4qQmEA8lh1iuvJbW1L0zJaRxfO1EHFa27o_A/exec';
    var table;
    
    function updateProgress(percentage, text) {
        const progressBar = $('#progressBar');
        const progressText = $('#progressText');
        progressBar.css('width', percentage + '%').attr('aria-valuenow', percentage);
        progressText.text(`${text} (${percentage}%)`);
    }

    async function loadAllDataAndInitTable() {
        $('#loadingIndicator').show();
        updateProgress(0, 'Initializing...');
        // Versioned cache key to auto-invalidate on code updates
        const cacheKey = 'drugMasterDataCache_v5.0_JSON';

        try {
            const cachedItem = localStorage.getItem(cacheKey);
            if (cachedItem) {
                updateProgress(10, 'Verifying cache...');
                const { checksum: cachedChecksum } = JSON.parse(cachedItem);
                const checkResponse = await fetch(`${webAppUrl}?action=check`);
                const serverStatus = await checkResponse.json();
                
                if (serverStatus.checksum === cachedChecksum) {
                    updateProgress(50, 'Cache is fresh. Loading...');
                    const { apiResponse } = JSON.parse(cachedItem);
                    initializeDataTable(apiResponse.data);
                    updateProgress(100, 'Finished');
                    setTimeout(() => $('#loadingIndicator').hide(), 500);
                    return;
                }
            }

            updateProgress(25, 'Fetching updated data...');
            const response = await fetch(webAppUrl);
            if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
            const apiResponse = await response.json();
            if (apiResponse.status !== 'success') throw new Error(`API Error: ${apiResponse.message}`);
            updateProgress(75, 'Data received, preparing table...');
            
            const dataToCache = { checksum: apiResponse.checksum, apiResponse: apiResponse };
            localStorage.setItem(cacheKey, JSON.stringify(dataToCache));
            
            initializeDataTable(apiResponse.data);
            updateProgress(100, 'Finished');
            setTimeout(() => $('#loadingIndicator').hide(), 500);
        } catch (error) {
            $('#loadingIndicator').hide();
            console.error("Data Load Error:", error);
            Swal.fire({ icon: 'error', title: 'Data Load Error', text: `Failed to load data: ${error.message}` });
        }
    }
    
    const drugGroupColorMap = {
        'gastro-intestinal system': 'bg-success', 'cardiovascular system': 'bg-danger', 'respiratory system': 'bg-info text-dark',
        'central nervous system': 'bg-purple', 'infections': 'bg-warning text-dark', 'endocrine system': 'bg-orange', 'obstetrics': 'bg-pink',
        'malignant disease': 'bg-dark', 'nutrition and blood': 'bg-primary', 'musculoskeletal': 'bg-teal', 'eye': 'bg-secondary',
        'ear, nose, and oropharynx': 'bg-light text-dark', 'skin': 'bg-warning text-dark', 'immunological': 'bg-info text-dark',
        'anesthesia': 'bg-purple', 'antidotes': 'bg-danger', 'contrast media': 'bg-primary', 'other': 'bg-secondary'
    };
    
    function formatNumber(data, minDecimals = 0, maxDecimals = 0) {
        const number = parseFloat(data);
        if (isNaN(number)) return data === null || data === '' ? '-' : data;
        return number.toLocaleString('en-US', { minimumFractionDigits: minDecimals, maximumFractionDigits: maxDecimals });
    }

    function renderBadge(data, type, map) {
        if (type === 'display' && data) {
            const status = data.toLowerCase().trim();
            const key = Object.keys(map).find(k => status.includes(k.toLowerCase()));
            const cls = key ? map[key] : 'bg-secondary';
            // WCAG 1.1.1 Non-text Content & 4.1.2 Name, Role, Value: Provide descriptive labels
            const ariaLabel = `สถานะ: ${data}`;
            return `<span class="badge ${cls}" aria-label="${ariaLabel}" title="${data}">${data}</span>`;
        }
        return data;
    }

    function initializeDataTable(data) {
        // --- Core Requirement: Responsive DataTables with Priority Columns ---
        // 'responsivePriority' determines which columns remain visible on smaller screens.
        // Lower number = higher priority. 'all' class forces visibility. 'none' hides.
        const columnConfig = [
            { title: 'Detail', data: null, defaultContent: '<button class="btn btn-sm btn-primary" aria-label="View details"><i class="fas fa-eye"></i></button>', orderable: false, className: 'all dtr-control', responsivePriority: 1 },
            { title: 'Material No.', data: 0, responsivePriority: 4 },
            { title: 'SAP Name', data: 1, width: "25%", className: 'all', responsivePriority: 2, render: (d) => `<strong class="text-primary">${d}</strong>` },
            { title: 'Generic Name', data: 2, width: "25%", responsivePriority: 3 },
            { title: 'TPU', data: 3, className: 'none' }, // 'none' class hides it by default, available in child row
            { title: 'GPU', data: 4, className: 'none' },
            { title: 'เงื่อนไขการเบิกจ่าย', data: 5, className: 'none', render: (d,t) => renderBadge(d,t, {'สำรองจ่าย': 'bg-primary', 'ocpa': 'bg-success'})},
            { title: 'บัญชียา', data: 6, responsivePriority: 6, render: (d,t) => renderBadge(d,t, {'ned': 'bg-danger', 'ed': 'bg-success'})},
            { title: 'ราคาขาย / หน่วย', data: 8, responsivePriority: 5, render: (d, t, row) => `${formatNumber(d, 2, 2)} / ${row[9] || 'หน่วย'}` },
            { title: 'ราคาทุน / หน่วย', data: 10, className: 'none', render: (d, t, row) => `${formatNumber(d, 2, 2)} / ${row[11] || 'หน่วย'}` },
            { title: 'Status', data: 12, responsivePriority: 7, render: (d,t) => renderBadge(d,t, {'ในบัญชี': 'bg-success', 'ตัดออกจากบัญชี': 'bg-danger'})},
            // Other columns are hidden by default on small screens
            { title: 'Drug Group', data: 25, className: 'none', render: (d, t) => renderBadge(d, t, drugGroupColorMap) },
            { title: 'Image 1', data: 43, visible: false }, // Data-only columns
        ];
    
        table = $('#drugTable').DataTable({
            data: data,
            columns: columnConfig,
            // Core Requirement: Responsive DataTables Extension enabled
            responsive: {
                details: {
                    type: 'column',
                    target: 'td:first-child'
                }
            },
            dom: 'rt<"bottom d-flex justify-content-between align-items-center mt-3"lip>',
            pageLength: 10,
            lengthMenu: [10, 25, 50, 100],
            language: { info: "Showing _START_ to _END_ of _TOTAL_ entries" }
        });

        // Search and Filter logic
        $('#globalSearch').on('keyup', function () { table.search(this.value).draw(); });
        $('#toggleFilterBtn').on('click', (e) => {
            const isExpanded = $(e.currentTarget).attr('aria-expanded') === 'true';
            $(e.currentTarget).attr('aria-expanded', !isExpanded);
            $('#filterPanel').slideToggle();
        });

        // Modal population and display logic
        $('#drugTable tbody').on('click', 'button', function () {
            const row = table.row($(this).closest('tr'));
            if (!row.length) return;
            const rowData = row.data();
            
            $('#drugDetailModalLabel').html(`<strong>${rowData[1] || ''}</strong>`);
            
            // Performance & CLS Prevention: Add loading="lazy" and aspect-ratio
            const imageUrl = rowData[43];
            const imageHtml = imageUrl ? `<img src="${imageUrl}" class="drug-image" alt="Image of ${rowData[1]}" loading="lazy">` : '<p>No image available.</p>';
            
            const detailsHtml = `
                <div class="row g-3">
                    <div class="col-lg-8">
                        <div class="detail-item"><strong>Generic Name</strong><div>${rowData[2] || '-'}</div></div>
                        <div class="detail-item mt-3"><strong>SAP Name</strong><div>${rowData[1] || '-'}</div></div>
                        <div class="detail-item mt-3"><strong>Material No.</strong><div>${rowData[0] || '-'}</div></div>
                    </div>
                    <div class="col-lg-4">
                        ${imageHtml}
                    </div>
                </div>
            `;
            $('#drugDetailModalBody').html(detailsHtml);
            $('#drugDetailModal').modal('show');
        });
        
        // --- Core Requirement: Accessible Modal Focus Management ---
        const drugDetailModal = document.getElementById('drugDetailModal');
        drugDetailModal.addEventListener('shown.bs.modal', () => {
            // WCAG 2.4.3 Focus Order: Set initial focus on the modal body
            const modalBody = drugDetailModal.querySelector('#drugDetailModalBody');
            modalBody.focus();
        });
        
        // WCAG 2.1.2 Keyboard Trap: Trap focus within the modal
        drugDetailModal.addEventListener('keydown', (event) => {
            if (event.key !== 'Tab') return;
            
            const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
            const modal = $(drugDetailModal);
            const focusableContent = modal.find(focusableElements);
            const firstFocusableElement = focusableContent[0];
            const lastFocusableElement = focusableContent[focusableContent.length - 1];

            if (event.shiftKey) { // Shift + Tab
                if (document.activeElement === firstFocusableElement) {
                    lastFocusableElement.focus();
                    event.preventDefault();
                }
            } else { // Tab
                if (document.activeElement === lastFocusableElement) {
                    firstFocusableElement.focus();
                    event.preventDefault();
                }
            }
        });
    }
    
    // Initial data load
    loadAllDataAndInitTable();
});
</script>
</body>
</html>

