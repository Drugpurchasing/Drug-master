<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <title>สรุปข้อมูลยาเข้าใหม่</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        /* --- Base & Custom Styles --- */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8fafc; /* Lighter gray background */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Drug Group Card Borders --- */
        .card-druggroup-1 { border-left-color: #F87171; } /* Red */
        .card-druggroup-2 { border-left-color: #A78BFA; } /* Purple */
        .card-druggroup-3 { border-left-color: #FBBF24; } /* Amber */
        .card-druggroup-4 { border-left-color: #60A5FA; } /* Blue */
        .card-druggroup-5 { border-left-color: #4ADE80; } /* Green */
        .card-druggroup-misc { border-left-color: #9CA3AF; } /* Gray */

        /* --- Filter Tag Colors --- */
        .tag-filter-1 { background-color: #FECACA; color: #991B1B; }
        .tag-filter-2 { background-color: #D8B4FE; color: #581C87; }
        .tag-filter-3 { background-color: #FDE68A; color: #9A3412; }
        .tag-filter-4 { background-color: #BFDBFE; color: #1E3A8A; }
        .tag-filter-5 { background-color: #BBF7D0; color: #15803D; }
        .tag-filter-misc { background-color: #D1D5DB; color: #1F2937; }
        .tag-filter-group { background-color: #A5F3FC; color: #0E7490; }

        /* --- Status Tags --- */
        .tag-ed { background-color: #D1FAE5; color: #065F46; }
        .tag-ned { background-color: #FEE2E2; color: #991B1B; border: 1px solid #FCA5A5; }
        .tag-nonstock { background-color: #DBEAFE; color: #1E40AF; }
        .tag-default { background-color: #E5E7EB; color: #374151; }
        /* MODIFICATION: Increased tag size */
        .category-tag {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 1rem;
        }

        /* --- Loader Animation --- */
        #loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3b82f6; /* Tailwind blue-500 */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Filter Button Styles --- */
        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border: 1px solid #D1D5DB; /* Gray-300 */
            background-color: #fff;
        }
        .filter-btn:hover {
            border-color: #9CA3AF; /* Gray-400 */
            background-color: #F9FAFB; /* Gray-50 */
        }
        .filter-btn.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            color: white;
            border-color: transparent !important;
        }
        .filter-btn.active[data-filter="all"] { background-color: #4B5563; } /* Gray-600 */
        .filter-btn.active.tag-filter-1 { background-color: #EF4444; } /* Red-500 */
        .filter-btn.active.tag-filter-2 { background-color: #8B5CF6; } /* Violet-500 */
        .filter-btn.active.tag-filter-3 { background-color: #F59E0B; } /* Amber-500 */
        .filter-btn.active.tag-filter-4 { background-color: #3B82F6; } /* Blue-500 */
        .filter-btn.active.tag-filter-5 { background-color: #22C55E; } /* Green-500 */
        .filter-btn.active.tag-filter-misc { background-color: #6B7280; } /* Gray-500 */
        .filter-btn.active.tag-filter-group { background-color: #0891B2; } /* Cyan-600 */

        /* --- Label Colors --- */
        .label-indication { color: #2563EB; }
        .label-dose { color: #16A34A; }
        .label-unit { color: #9333EA; }
        .label-proposer { color: #475569; }
        .label-storage { color: #0891B2; }
        .label-food { color: #D97706; }
        .label-comparable { color: #52525B; }
        .label-notes { color: #BE123C; }

        /* --- Drug Image Styling --- */
        .drug-image-container {
            display: flex;
            /* MODIFICATION: Changed to column for vertical stacking */
            flex-direction: column;
            gap: 0.75rem; /* Space between images */
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 200px; /* Minimum height for consistency */
        }
        .drug-image {
            width: 100%;
            height: auto;
            max-height: 360px; /* Limit max height */
            flex-shrink: 1;
            object-fit: contain;
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="text-gray-800">

<div class="container mx-auto p-4 md:p-8 max-w-7xl">
    <header class="text-center mb-12 flex flex-col items-center justify-center gap-4">
        <img src="CRAlogo.png" alt="Logo" class="h-16 w-auto">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 tracking-tight">สรุปข้อมูลยาเข้าใหม่</h1>
    </header>

    <div id="controls" class="py-6 mb-10 space-y-6 bg-white shadow-sm rounded-xl p-6 border border-gray-200/80">
        <div class="relative max-w-3xl mx-auto">
            <input type="text" id="searchInput" class="w-full p-3 pl-12 text-lg border-2 border-gray-300 rounded-full focus:ring-2 focus:ring-blue-400 focus:border-blue-500 transition-all duration-300" placeholder="ค้นหาชื่อยา, ชื่อสามัญ, รหัสยา...">
            <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
        </div>
        <div class="flex flex-col md:flex-row md:items-start md:justify-center gap-x-10 gap-y-6 pt-4">
            <div class="text-center">
                <p class="font-semibold text-gray-600 mb-3 text-lg">Filter by กลุ่มยา:</p>
                <div id="category-filter-container" class="flex flex-wrap gap-3 justify-center"></div>
            </div>
            <div class="text-center">
                <p class="font-semibold text-gray-600 mb-3 text-lg">Filter by รอบที่เสนอเข้า:</p>
                <div id="group-filter-container" class="flex flex-wrap gap-3 justify-center"></div>
            </div>
        </div>
    </div>

    <div id="loading-container" class="flex flex-col items-center justify-center p-10">
        <div id="loader"></div>
        <p class="text-gray-600 mt-6 text-lg">กำลังโหลดข้อมูล กรุณารอสักครู่...</p>
    </div>
    
    <div id="drug-list" class="space-y-8"></div>
</div>

<div id="floating-toolbar" class="fixed bottom-6 right-6 z-40 flex flex-col items-end gap-3">
    <button id="scrollToTopBtn" title="กลับขึ้นบนสุด" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-full shadow-lg transition-all duration-300 flex items-center gap-2 px-4 py-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
        <span class="hidden sm:inline">กลับขึ้นบนสุด</span>
    </button>
    <button id="openReportModalBtn" title="ขอแก้ไขข้อมูล, แจ้งปัญหา, สอบถาม, หรือส่งข้อเสนอแนะ" class="bg-green-600 hover:bg-green-700 text-white font-semibold rounded-full shadow-lg transition-all duration-300 flex items-center gap-2 px-4 py-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
        <span class="hidden sm:inline">ติดต่อ/แจ้งปัญหา</span>
    </button>
</div>

<div id="reportModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
    <div class="relative mx-auto p-6 border w-full max-w-lg shadow-2xl rounded-2xl bg-white">
        <button id="closeReportModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
             <svg class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        <div class="mt-3 text-center">
            <h3 class="text-2xl leading-6 font-bold text-gray-900">ติดต่อผู้ดูแลระบบ</h3>
            <p class="text-base text-gray-500 mt-2 px-4">เลือกหัวข้อและกรอกรายละเอียดที่ต้องการแจ้ง</p>
            <form id="reportForm" class="mt-6 text-left space-y-5">
                <div>
                    <label class="font-semibold text-gray-700">หัวข้อการติดต่อ:</label>
                    <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 has-[:checked]:ring-2 has-[:checked]:ring-blue-200 transition-all">
                            <input type="radio" name="topic" value="ขอแก้ไขข้อมูลยา" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                            <span class="ml-3 text-gray-800">ขอแก้ไขข้อมูลยา</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 has-[:checked]:ring-2 has-[:checked]:ring-blue-200 transition-all">
                            <input type="radio" name="topic" value="พบปัญหาการใช้งาน" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-3 text-gray-800">พบปัญหา</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 has-[:checked]:ring-2 has-[:checked]:ring-blue-200 transition-all">
                            <input type="radio" name="topic" value="คำถาม" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-3 text-gray-800">คำถาม</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 has-[:checked]:ring-2 has-[:checked]:ring-blue-200 transition-all">
                            <input type="radio" name="topic" value="ข้อเสนอแนะ" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-3 text-gray-800">ข้อเสนอแนะ</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label for="message" class="font-semibold text-gray-700">รายละเอียด:</label>
                    <textarea id="message" name="message" rows="5" class="mt-2 p-3 w-full text-base border-2 border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition" placeholder="กรุณาระบุรายละเอียด เช่น ชื่อยาที่ต้องการแก้ไข หรือปัญหาที่พบ..." required></textarea>
                </div>
                <div class="items-center gap-4 pt-4 flex">
                     <button type="button" class="form-cancel-btn flex-1 px-4 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all">ยกเลิก</button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-blue-600 text-white text-base font-semibold rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all">ส่งเรื่อง</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// --- CONSTANTS AND GLOBAL VARIABLES ---
const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTv6yIfVLrXZ76oqef80u3iZbheswq3h-igusVAjNryZYucvVhnXc35I2HDNvEZr-4FYf4rwIu9EHn-/pub?gid=0&single=true&output=csv';
const drugListContainer = document.getElementById('drug-list');
const loadingContainer = document.getElementById('loading-container');
const searchInput = document.getElementById('searchInput');
const categoryFilterContainer = document.getElementById('category-filter-container');
const groupFilterContainer = document.getElementById('group-filter-container');
let allDrugData = [];

// --- CORE DATA HANDLING AND RENDERING FUNCTIONS ---
function sanitizeHTML(text) { if (!text) return ''; const temp = document.createElement('div'); temp.textContent = text; return temp.innerHTML; }
function getDrugGroupCode(code) { return ['1', '2', '3', '4', '5'].includes(String(code)) ? String(code) : 'misc'; }
function getOrder(value, fallback = 999) { const num = parseInt(value, 10); return isNaN(num) ? fallback : num; }

function formatNotesAdvanced(text) {
    if (!text || text.trim() === '') return '-';
    let sanitizedText = sanitizeHTML(text);

    // MODIFICATION: Added all requested keywords to this regex for highlighting
    const keywordsToHighlight = /ห้าม|ควรระวัง|กำหนด|ไม่ควร|ไม่ |หลีกเลี่ยง|กรณี|เปรียบเทียบ|ปริมาณน้อย|ไม่สามารถ|กำหนดเงื่อนไขการสั่งเฉพาะ|ใช้แทน|กำหนดข้อบ่งใช้|จำกัดผู้สั่ง|จำกัด|สำหรับ/g;
    sanitizedText = sanitizedText.replace(keywordsToHighlight, '<strong class="text-red-600 underline decoration-2 decoration-wavy">$&</strong>');

    const lines = sanitizedText.split(/\\n|\n/g);
    let finalHtml = lines.map(line => {
        let processedLine = line.trim();
        // Indent list items
        if (/^(\d+\.\d+|\d+\)|\-|\•)\s/.test(processedLine)) {
            return `<div class="pl-5">${processedLine}</div>`;
        }
        return processedLine;
    }).join('<br />');

    // Wrap other keywords in styled tags
    finalHtml = finalHtml.replace(/เบิกไม่ได้/g, '<span class="font-bold text-red-700 px-2.5 py-1 bg-red-100 rounded-md ring-1 ring-red-200">$&</span>');
    finalHtml = finalHtml.replace(/Non-stock/g, '<span class="font-bold text-blue-700 px-2.5 py-1 bg-blue-100 rounded-md ring-1 ring-blue-200">$&</span>');
    finalHtml = finalHtml.replace(/สำรองจ่าย/g, '<span class="font-bold text-cyan-700 px-2.5 py-1 bg-cyan-100 rounded-md ring-1 ring-cyan-200">$&</span>');
    finalHtml = finalHtml.replace(/เข้าทดแทน/g, '<span class="font-bold text-purple-700 px-2.5 py-1 bg-purple-100 rounded-md ring-1 ring-purple-200">$&</span>');

    return finalHtml;
}


async function loadDrugData() {
    try {
        const response = await fetch(googleSheetUrl);
        if (!response.ok) throw new Error(`Network response error: ${response.statusText}`);
        const csvText = await response.text();
        Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            trimHeaders: true,
            complete: (results) => {
                loadingContainer.style.display = 'none';
                if (results.errors.length) console.error("CSV Parsing Errors:", results.errors);
                allDrugData = results.data.filter(row => row.sapCode && row.sapCode.trim() !== '');
                if (allDrugData.length === 0) {
                    drugListContainer.innerHTML = '<p class="text-center text-red-500 font-semibold text-xl">ไม่มีข้อมูลที่จะแสดง</p>';
                    return;
                }
                setupCategoryFilters();
                setupGroupFilters();
                renderGroupedCards(allDrugData);
                setupEventListeners();
            },
            error: (err) => {
                loadingContainer.innerHTML = `<p class="text-red-600 font-bold text-xl">เกิดข้อผิดพลาดในการโหลดข้อมูล: ${err.message}</p>`;
            }
        });
    } catch (error) {
        loadingContainer.innerHTML = `<p class="text-red-600 font-bold text-xl">เกิดข้อผิดพลาด: ${error.message}</p>`;
    }
}

function renderGroupedCards(drugData) {
    drugListContainer.innerHTML = '';
    const fragment = document.createDocumentFragment();
    const activeGroupFilter = groupFilterContainer.querySelector('.active')?.dataset.filter || 'all';

    if (drugData.length === 0) {
        drugListContainer.innerHTML = '<p class="text-center text-gray-500 font-semibold mt-8 text-xl">ไม่พบข้อมูลยาที่ตรงกับเงื่อนไขการค้นหา</p>';
        return;
    }

    const groupsToRender = drugData.reduce((acc, drug) => {
        const groupName = (drug.group || 'ไม่ระบุรอบการนำเข้า').trim();
        if (!acc[groupName]) {
            acc[groupName] = { drugs: [], groupOrder: drug.groupOrder };
        }
        acc[groupName].drugs.push(drug);
        return acc;
    }, {});

    const sortedGroupNames = Object.keys(groupsToRender).sort((a, b) => {
        if (activeGroupFilter !== 'all') {
            if (a === activeGroupFilter && b !== activeGroupFilter) return -1;
            if (b === activeGroupFilter && a !== activeGroupFilter) return 1;
        }
        return getOrder(groupsToRender[a].groupOrder) - getOrder(groupsToRender[b].groupOrder);
    });

    sortedGroupNames.forEach(groupName => {
        const groupInfo = groupsToRender[groupName];
        const drugsInGroup = groupInfo.drugs.sort((a, b) => getOrder(a.itemOrder) - getOrder(b.itemOrder));
        if (drugsInGroup.length > 0) {
            fragment.appendChild(document.createRange().createContextualFragment(createGroupHeaderHTML(groupName)));
            drugsInGroup.forEach(drug => fragment.appendChild(document.createRange().createContextualFragment(createDrugCardHTML(drug))));
        }
    });
    drugListContainer.appendChild(fragment);
}

function createGroupHeaderHTML(groupName) {
    return `<div class="mt-12 mb-5"><h2 class="text-2xl md:text-3xl font-bold text-gray-800 border-b-2 border-gray-400 pb-3">${sanitizeHTML(groupName)}</h2></div>`;
}

function createDrugCardHTML(drug) {
    // --- Helper Functions & Data Preparation ---
    const formatContent = (text, fallback = '-') => (sanitizeHTML(text) || fallback).replace(/\\n|\n/g, '<br>');
    const druggroup = getDrugGroupCode(drug.code);
    const sanitizedName = sanitizeHTML(drug.name || '');
    
    // --- Drug Type & Tags ---
    let drugTypeTagClass = 'tag-default';
    const drugTypeOriginal = drug.type || '';
    const drugTypeUpper = drugTypeOriginal.toUpperCase();
    if (drugTypeUpper.includes('NED') || drugTypeOriginal.includes('เบิกไม่ได้')) {
        drugTypeTagClass = 'tag-ned';
    } else if (drugTypeUpper.includes('ED') || drugTypeOriginal.includes('สมุนไพรในบัญชี')) {
        drugTypeTagClass = 'tag-ed';
    }
    const isNonStock = (drug.name || '').toLowerCase().includes('non-stock');
    const nonStockTag = isNonStock ? `<span class="category-tag tag-nonstock">Non-stock</span>` : '';

    // --- Image Handling (Supports 2 images) ---
    const imageUrl1 = drug.image && drug.image.trim() !== '' ? drug.image.trim() : '';
    const imageUrl2 = drug.image2 && drug.image2.trim() !== '' ? drug.image2.trim() : '';
    let imagesContent = '';
    const onErrorScript = `this.style.display='none';`;
    if (imageUrl1) {
        imagesContent += `<img src="${imageUrl1}" alt="รูปยา ${sanitizedName} 1" class="drug-image" onerror="${onErrorScript}">`;
    }
    if (imageUrl2) {
        imagesContent += `<img src="${imageUrl2}" alt="รูปยา ${sanitizedName} 2" class="drug-image" onerror="${onErrorScript}">`;
    }
    if (!imageUrl1 && !imageUrl2) {
        imagesContent = '<div class="flex items-center justify-center bg-gray-100 w-full h-full rounded-lg text-gray-400">ไม่มีรูปภาพ</div>';
    }

    // --- Content Sections ---
    const indicationHTML = `<div class="flex items-start text-lg mt-4"> <span class="label-indication mt-1"><svg class="h-6 w-6 mr-3 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M12.963 2.286a.75.75 0 00-1.071 1.052A11.213 11.213 0 0112 15a11.213 11.213 0 01-9.892-11.662.75.75 0 00-1.071-1.052A12.713 12.713 0 001.5 15C1.5 21.627 6.873 27 13.5 27s12-5.373 12-12c0-5.12-3.213-9.489-7.537-11.348z" clip-rule="evenodd" /></svg></span> <div><strong class="font-semibold label-indication">ข้อบ่งชี้:</strong><div class="mt-1 text-gray-700">${formatContent(drug.indication)}</div></div> </div>`;
    const comparableDrug = formatContent(drug['Comparable drug']);
    const comparableDrugHTML = comparableDrug && comparableDrug !== '-' 
        ? `<div class="flex items-start text-base mt-4"> <span class="label-comparable mt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1z" /></svg></span> <div><strong class="font-semibold label-comparable">ยาในบัญชีฯ ที่ใกล้เคียง:</strong><div class="mt-1 text-gray-700">${comparableDrug}</div></div> </div>` 
        : '';
    const foodInteraction = formatContent(drug.food);
    const foodHTML = foodInteraction && foodInteraction !== '-' 
        ? `<div class="flex items-start"> <span class="label-food mt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path d="M18 3a1 1 0 00-1.447-.894L8.763 6H5a3 3 0 00-3 3v2.236l-1.063.807a1 1 0 00.414 1.832L3 13.447V17a1 1 0 001 1h12a1 1 0 001-1v-3.553l1.649-.412a1 1 0 00.553-1.832L17 10.236V6a3 3 0 00-3-3h-3.763L18 3zM16 6v4.062l-.5.125-10-2.5V6a1 1 0 011-1h8a1 1 0 011 1z" /></svg></span> <div><strong class="font-semibold label-food">Food Interaction:</strong><div class="mt-1 text-gray-700">${foodInteraction}</div></div> </div>` 
        : '';

    // --- Final Card Assembly ---
    return `
    <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-shadow duration-300 flex flex-col md:flex-row border-l-8 card-druggroup-${druggroup} border-t border-gray-200/80">
        <div class="md:w-2/5 flex-shrink-0 bg-slate-50 flex items-center justify-center p-4 border-b md:border-b-0 md:border-r border-gray-200">
            <div class="drug-image-container">${imagesContent}</div>
        </div>
        <div class="flex-grow flex flex-col">
            <div class="p-6 flex-grow">
                <div class="flex justify-between items-start gap-4">
                    <div class="flex-grow">
                        <p class="text-xl font-medium text-gray-600">${formatContent(drug.generic)}</p>
                        <h3 class="text-2xl md:text-3xl font-bold text-gray-900 mt-1">${formatContent(drug.name)}</h3>
                        <p class="text-lg text-gray-500 font-mono mt-2">SAP Code: ${formatContent(drug.sapCode)}</p>
                    </div>
                    <div class="flex flex-col items-end gap-y-2 flex-shrink-0 mt-1">
                        <span class="category-tag whitespace-nowrap ${drugTypeTagClass}">${formatContent(drug.type)}</span>
                        ${nonStockTag}
                    </div>
                </div>
                <hr class="my-5 border-gray-200">
                ${indicationHTML}
                ${comparableDrugHTML}
                <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-6 text-lg">
                    <div class="flex items-start"> <span class="label-dose mt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 2a1 1 0 00-1 1v1H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 00-1-1H7zm2 10a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" /></svg></span> <div><strong class="font-semibold label-dose">ขนาดใช้ยา:</strong><div class="mt-1 text-gray-700">${formatContent(drug.dose)}</div></div> </div>
                    <div class="flex items-start"> <span class="label-unit mt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path d="M8.75 3.75a.75.75 0 00-1.5 0v3.5h-3.5a.75.75 0 000 1.5h3.5v3.5a.75.75 0 001.5 0v-3.5h3.5a.75.75 0 000-1.5h-3.5v-3.5zM16 5.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM17.5 16a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM4 17.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0zM2.5 4a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" /></svg></span> <div><strong class="font-semibold label-unit">หน่วยจัดซื้อ:</strong><div class="mt-1 text-gray-700">${formatContent(drug.unit)}</div></div> </div>
                    <div class="flex items-start"> <span class="label-proposer mt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg></span> <div><strong class="font-semibold label-proposer">แพทย์ผู้เสนอ:</strong><div class="mt-1 text-gray-700">${formatContent(drug.proposer)}</div></div> </div>
                    <div class="flex items-start"> <span class="label-storage mt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.05 5.05a.75.75 0 011.06 0l2.5 2.5a.75.75 0 01-1.06 1.06L10 7.06l-1.54 1.55a.75.75 0 11-1.06-1.06l2.5-2.5zM10 12a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 12z" clip-rule="evenodd" /></svg></span> <div><strong class="font-semibold label-storage">การจัดเก็บ:</strong><div class="mt-1 text-gray-700">${formatContent(drug.storage)}</div></div> </div>
                    ${foodHTML}
                </div>
            </div>
            <div class="bg-rose-50 px-6 py-5 mt-auto border-t-2 border-rose-200/80">
                <div class="flex items-start text-lg">
                    <span class="label-notes mt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg></span>
                    <div>
                        <strong class="font-bold underline decoration-2 label-notes">หมายเหตุ:</strong>
                        <div class="mt-2 text-gray-800 text-lg leading-relaxed">${formatNotesAdvanced(drug.notes)}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>`;
}

// --- SETUP AND EVENT LISTENERS (No functional changes, only minor adjustments for new modal) ---
function setupEventListeners() {
    searchInput.addEventListener('input', filterAndRender);
    const handleFilterClick = (container) => (e) => {
        if (e.target.tagName === 'BUTTON') {
            const currentActive = container.querySelector('.active');
            if (currentActive) currentActive.classList.remove('active');
            e.target.classList.add('active');
            filterAndRender();
        }
    };
    categoryFilterContainer.addEventListener('click', handleFilterClick(categoryFilterContainer));
    groupFilterContainer.addEventListener('click', handleFilterClick(groupFilterContainer));
}

function setupCategoryFilters() {
    const categories = allDrugData.reduce((acc, drug) => {
        const druggroup = getDrugGroupCode(drug.code);
        const name = drug.druggroupName || `ยา กลุ่ม ${druggroup}`;
        if (!acc[druggroup]) {
            acc[druggroup] = { name: name.trim(), code: druggroup };
        }
        return acc;
    }, {});
    let filterHtml = '<button class="filter-btn active" data-filter="all">ทั้งหมด</button>';
    Object.values(categories).sort((a,b) => a.code.localeCompare(b.code)).forEach(cat => {
        filterHtml += `<button class="filter-btn tag-filter-${cat.code}" data-filter="${cat.code}">${sanitizeHTML(cat.name)}</button>`;
    });
    categoryFilterContainer.innerHTML = filterHtml;
}

function setupGroupFilters() {
    const groups = [...new Set(allDrugData.map(drug => (drug.group || '').trim()).filter(Boolean))];
    let filterHtml = '<button class="filter-btn active" data-filter="all">ทั้งหมด</button>';
    groups.sort().forEach(group => {
        const buttonText = group.replace(/\s*\(.*\)/, ''); // Keep this logic
        filterHtml += `<button class="filter-btn tag-filter-group" data-filter="${group}">${sanitizeHTML(buttonText)}</button>`;
    });
    groupFilterContainer.innerHTML = filterHtml;
}

function filterAndRender() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    const activeCategoryFilter = categoryFilterContainer.querySelector('.active').dataset.filter;
    const activeGroupFilter = groupFilterContainer.querySelector('.active').dataset.filter;
    const filteredData = allDrugData.filter(drug => {
        const searchableContent = (drug.name + ' ' + drug.generic + ' ' + drug.sapCode).toLowerCase();
        const matchesSearch = searchTerm === '' || searchableContent.includes(searchTerm);
        const matchesCategory = activeCategoryFilter === 'all' || getDrugGroupCode(drug.code) === activeCategoryFilter;
        const matchesGroup = activeGroupFilter === 'all' || (drug.group || '').trim() === activeGroupFilter;
        return matchesSearch && matchesCategory && matchesGroup;
    });
    renderGroupedCards(filteredData);
}

// ===== FLOATING TOOLBAR & MODAL SCRIPT START =====
const scrollToTopBtn = document.getElementById('scrollToTopBtn');
const openReportModalBtn = document.getElementById('openReportModalBtn');
const reportModal = document.getElementById('reportModal');
const closeReportModalBtn = document.getElementById('closeReportModalBtn');
const formCancelBtn = document.querySelector('.form-cancel-btn'); // New cancel button in form
const reportForm = document.getElementById('reportForm');

window.onscroll = function() {
    if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
        scrollToTopBtn.style.display = "flex";
    } else {
        scrollToTopBtn.style.display = "none";
    }
};
scrollToTopBtn.addEventListener('click', function() {
    window.scrollTo({top: 0, behavior: 'smooth'});
});

function openModal() { reportModal.classList.remove('hidden'); }
function closeModal() { reportModal.classList.add('hidden'); }

openReportModalBtn.addEventListener('click', openModal);
closeReportModalBtn.addEventListener('click', closeModal);
formCancelBtn.addEventListener('click', closeModal); // Make form cancel button work
reportModal.addEventListener('click', function(event) {
    if (event.target === reportModal) {
        closeModal();
    }
});

reportForm.addEventListener('submit', function(event) {
    event.preventDefault();
    const webAppUrl = 'https://script.google.com/macros/s/AKfycbyH_ULtPI5Wat_VmNY7smo7Ytq2jfk0DcKgFmjFQU5FXTyG2ICT9-5ro4Bj70TQ0tjS/exec';
    const formData = new FormData(reportForm);
    const data = Object.fromEntries(formData.entries());
    const submitButton = reportForm.querySelector('button[type="submit"]');

    if (webAppUrl === 'YOUR_WEB_APP_URL_HERE') {
        alert('Error: กรุณาตั้งค่า Web App URL ในไฟล์ HTML ก่อนใช้งาน');
        return;
    }

    submitButton.disabled = true;
    submitButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>กำลังส่ง...`;

    fetch(webAppUrl, {
        method: 'POST',
        mode: 'no-cors',
        cache: 'no-cache',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
        redirect: 'follow'
    })
    .then(response => {
        console.log('Form submitted');
        alert('ส่งข้อมูลเรียบร้อยแล้ว ขอบคุณสำหรับข้อมูลครับ/ค่ะ');
        closeModal();
        reportForm.reset();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('เกิดข้อผิดพลาดในการส่งข้อมูล: ' + error.message);
    })
    .finally(() => {
        submitButton.disabled = false;
        submitButton.textContent = 'ส่งเรื่อง';
    });
});
// ===== FLOATING TOOLBAR & MODAL SCRIPT END =====

// --- INITIAL LOAD ---
document.addEventListener('DOMContentLoaded', loadDrugData);

</script>
</body>
</html>
