<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <title>สรุปข้อมูลยาเข้าใหม่</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #F7FAFC;
        }

        /* --- DRUG GROUP BORDER COLORS --- */
        .card-druggroup-1 { border-left-color: #FCA5A5; }
        .card-druggroup-2 { border-left-color: #C4B5FD; }
        .card-druggroup-3 { border-left-color: #FED7AA; }
        .card-druggroup-4 { border-left-color: #60A5FA; }
        .card-druggroup-misc { border-left-color: #A3A3A3; }

        /* --- FILTER BUTTON TAG COLORS --- */
        .tag-filter-1 { background-color: #FECACA; color: #991B1B; }
        .tag-filter-2 { background-color: #D8B4FE; color: #581C87; }
        .tag-filter-3 { background-color: #FDBA74; color: #9A3412; }
        .tag-filter-4 { background-color: #93C5FD; color: #1E3A8A; }
        .tag-filter-misc { background-color: #D1D5DB; color: #1F2937; }

        /* --- ED/NED TAG COLORS (TOP-RIGHT) --- */
        .tag-ed { background-color: #D1FAE5; color: #047857; }
        /* NEW: Enhanced NED tag style */
        .tag-ned { background-color: #DC2626; color: white; } /* Red-600 background, white text */
        .tag-default { background-color: #E5E7EB; color: #374151; }

        .category-tag { padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 600; }
        
        #loader { border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .filter-btn { padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; transition: all 0.2s; border: 2px solid transparent;}
        .filter-btn.active { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .filter-btn:not(.active) { background-color: #fff; color: #4A5568; border-color: #E2E8F0; }

        /* --- LABEL COLORS --- */
        .label-indication { color: #2563EB; } /* Blue-600 */
        .label-dose       { color: #16A34A; } /* Green-600 */
        .label-unit       { color: #9333EA; } /* Purple-600 */
        .label-proposer   { color: #64748B; } /* Slate-500 */
        .label-storage    { color: #0891B2; } /* Cyan-600 */
        .label-food       { color: #D97706; } /* Amber-600 */
        .label-notes      { color: #DC2626; } /* Red-600 */
    </style>
</head>
<body class="text-gray-800">

<div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-800">สรุปข้อมูลยาเข้าใหม่</h1>
    </header>

    <div id="controls" class="py-4 mb-8">
        <div class="relative mb-4 max-w-2xl mx-auto">
            <input type="text" id="searchInput" class="w-full p-2 pl-10 text-base border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" placeholder="ค้นหาชื่อยา, ชื่อสามัญ, รหัสยา...">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
        </div>
        <div id="filter-container" class="flex flex-wrap gap-3 justify-center"></div>
    </div>

    <div id="loading-container" class="flex flex-col items-center justify-center p-10">
        <div id="loader"></div>
        <p class="text-gray-600 mt-4">กำลังโหลดข้อมูล กรุณารอสักครู่</p>
    </div>
    
    <div id="drug-list" class="space-y-8"></div>
</div>

<script>
const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTv6yIfVLrXZ76oqef80u3iZbheswq3h-igusVAjNryZYucvVhnXc35I2HDNvEZr-4FYf4rwIu9EHn-/pub?gid=0&single=true&output=csv';

const drugListContainer = document.getElementById('drug-list');
const loadingContainer = document.getElementById('loading-container');
const searchInput = document.getElementById('searchInput');
const filterContainer = document.getElementById('filter-container');

let allDrugData = [];

// --- UTILITY & FORMATTING FUNCTIONS ---
function sanitizeHTML(text) {
    if (!text) return '';
    const temp = document.createElement('div');
    temp.textContent = text;
    return temp.innerHTML;
}

function getDrugGroupCode(code) {
    return ['1', '2', '3', '4'].includes(String(code)) ? String(code) : 'misc';
}

function getOrder(value, fallback = 999) {
    const num = parseInt(value, 10);
    return isNaN(num) ? fallback : num;
}

function formatNotesAdvanced(text) {
    if (!text || text.trim() === '') return '-';
    let sanitizedText = sanitizeHTML(text);
    const lines = sanitizedText.split(/\\n|\n/g);
    let finalHtml = lines.map(line => {
        let processedLine = line.trim();
        processedLine = processedLine.replace(/กำหนดการสั่งเฉพาะ/g, '<strong class="text-red-600 underline">$&</strong>');
        if (/^(\d+\.\d+|\d+\)|\-|\•)\s/.test(processedLine)) {
            return `<div class="pl-4">${processedLine}</div>`;
        }
        return processedLine;
    }).join('<br />');

    finalHtml = finalHtml.replace(/เบิกไม่ได้/g, '<strong class="text-red-600 px-2 py-1 bg-red-100 rounded">$&</strong>');
    finalHtml = finalHtml.replace(/Non-stock/g, '<strong class="text-blue-600 px-2 py-1 bg-blue-100 rounded">$&</strong>');
    finalHtml = finalHtml.replace(/เข้าทดแทน/g, '<strong class="text-purple-600 px-2 py-1 bg-purple-100 rounded">$&</strong>');
    
    return finalHtml;
}

// --- DATA PROCESSING & RENDERING ---
async function loadDrugData() {
    try {
        const response = await fetch(googleSheetUrl);
        if (!response.ok) throw new Error(`Network response error: ${response.statusText}`);
        const csvText = await response.text();
        Papa.parse(csvText, {
            header: true, skipEmptyLines: true, trimHeaders: true,
            complete: (results) => {
                loadingContainer.style.display = 'none';
                if (results.errors.length) console.error("CSV Parsing Errors:", results.errors);
                allDrugData = results.data.filter(row => row.sapCode && row.sapCode.trim() !== '');
                if (allDrugData.length === 0) {
                    drugListContainer.innerHTML = '<p class="text-center text-red-500 font-semibold">ไม่มีข้อมูลที่จะแสดง</p>';
                    return;
                }
                setupFilters();
                renderGroupedCards(allDrugData);
                setupEventListeners();
            },
            error: (err) => { loadingContainer.innerHTML = `<p class="text-red-600 font-bold">CSV Error: ${err.message}</p>`; }
        });
    } catch (error) {
        loadingContainer.innerHTML = `<p class="text-red-600 font-bold">Load Error: ${error.message}</p>`;
    }
}

function renderGroupedCards(drugData) {
    drugListContainer.innerHTML = '';
    const fragment = document.createDocumentFragment();
    const drugGroups = drugData.reduce((acc, drug) => {
        const groupName = (drug.group || 'ไม่มีกลุ่ม').trim();
        if (!acc[groupName]) acc[groupName] = [];
        acc[groupName].push(drug);
        return acc;
    }, {});
    const sortedGroupNames = Object.keys(drugGroups).sort((a, b) => getOrder(drugGroups[a][0]?.groupOrder) - getOrder(drugGroups[b][0]?.groupOrder));
    
    if (drugData.length === 0) {
        drugListContainer.innerHTML = '<p class="text-center text-gray-500 font-semibold mt-8">ไม่พบข้อมูลที่ตรงกับเงื่อนไข</p>';
        return;
    }

    sortedGroupNames.forEach(groupName => {
        const drugsInGroup = drugGroups[groupName].filter(d => drugData.includes(d)).sort((a, b) => getOrder(a.itemOrder) - getOrder(b.itemOrder));
        if (drugsInGroup.length > 0) {
            fragment.appendChild(document.createRange().createContextualFragment(createGroupHeaderHTML(groupName)));
            drugsInGroup.forEach(drug => fragment.appendChild(document.createRange().createContextualFragment(createDrugCardHTML(drug))));
        }
    });
    drugListContainer.appendChild(fragment);
}

// NEW: Updated group header style to be black and underlined
function createGroupHeaderHTML(groupName) {
    return `<div class="mt-10 mb-4">
                <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-gray-800 pb-2">${"ยาเข้าบัญชี รอบ " + sanitizeHTML(groupName)}</h2>
            </div>`;
}

function createDrugCardHTML(drug) {
    const formatContent = (text) => (sanitizeHTML(text) || '-').replace(/\\n|\n/g, '<br>');
    const druggroup = getDrugGroupCode(drug.code);
    const notesInfo = formatNotesAdvanced(drug.notes);
    const indication = formatContent(drug.indication);
    const dose = formatContent(drug.dose);
    const proposerInfo = formatContent(drug.proposer);
    const unitInfo = formatContent(drug.unit);
    const storage = formatContent(drug.storage);
    const food = formatContent(drug.food);
    const sanitizedName = sanitizeHTML(drug.name || '');

    let drugTypeTagClass = 'tag-default';
    const drugTypeUpper = (drug.type || '').trim().toUpperCase();
    if (drugTypeUpper.includes('ED')) {
        drugTypeTagClass = 'tag-ed';
    } else if (drugTypeUpper.includes('NED')) {
        drugTypeTagClass = 'tag-ned';
    }

    const imageUrl1 = drug.image && drug.image.trim() !== '' ? drug.image.trim() : '';
    const imageUrl2 = drug.image2 && drug.image2.trim() !== '' ? drug.image2.trim() : '';
    const placeholderError = `this.onerror=null;this.src='https://placehold.co/600x400/E2E8F0/4A5568?text=Image+Error';`;
    const placeholderNotFound = 'https://placehold.co/600x400/E2E8F0/4A5568?text=No+Image';

    let imageHTML = '';
    if (imageUrl1 && imageUrl2) {
        imageHTML = `
            <div class="h-full w-full flex flex-col">
                <img class="h-1/2 w-full object-contain p-2" src="${imageUrl1}" alt="รูปยา ${sanitizedName} 1" onerror="${placeholderError}">
                <img class="h-1/2 w-full object-contain p-2" src="${imageUrl2}" alt="รูปยา ${sanitizedName} 2" onerror="${placeholderError}">
            </div>`;
    } else if (imageUrl1) {
        imageHTML = `<img class="h-full w-full object-contain p-2" src="${imageUrl1}" alt="รูปยา ${sanitizedName}" onerror="${placeholderError}">`;
    } else {
        imageHTML = `<img class="h-full w-full object-contain" src="${placeholderNotFound}" alt="ไม่มีรูปยา">`;
    }

    return `
    <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300 flex flex-col md:flex-row border-l-[6px] card-druggroup-${druggroup}">
        <div class="md:w-1/3 flex-shrink-0 bg-gray-50 flex items-center justify-center min-h-[200px] md:min-h-full">
            ${imageHTML}
        </div>

        <div class="flex-grow flex flex-col">
            <div class="p-6 flex-grow">
                <div class="flex justify-between items-start">
                    <div class="flex-grow pr-4">
                        <p class="text-lg font-semibold text-gray-500">${formatContent(drug.generic)}</p>
                        <h3 class="text-3xl font-bold text-gray-900 mt-1">${formatContent(drug.name)}</h3>
                        <p class="text-lg text-gray-500 font-mono mt-1">SAP Code: ${formatContent(drug.sapCode)}</p>
                    </div>
                    <span class="category-tag ${drugTypeTagClass} whitespace-nowrap" style="font-size: 1.5rem;">${formatContent(drug.type)}</span>
                </div>
                
                <hr class="my-4">

                <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-x-6 gap-y-5 text-lg text-gray-700 leading-relaxed">
                    <div class="flex items-start label-indication">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0 mt-1" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5.002v.01" /><path d="M12 19.002v.01" /><path d="M5 12.002v.01" /><path d="M19 12.002v.01" /><path d="M8.5 8.5v.01" /><path d="M15.5 8.5v.01" /><path d="M8.5 15.5v.01" /><path d="M15.5 15.5v.01" /></svg>
                        <div><strong class="font-semibold">ข้อบ่งใช้:</strong><div class="mt-1">${indication}</div></div>
                    </div>
                    <div class="flex items-start label-dose">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0 mt-1" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6.1 15h11.8" /><path d="M14 3v7.345a1 1 0 0 1 -.346 .75l-2.308 2.308a1 1 0 0 0 -.346 .75v5.847" /><path d="M10 3v7.345a1 1 0 0 0 .346 .75l2.308 2.308a1 1 0 0 1 .346 .75v5.847" /><path d="M3 15h1v-1a2 2 0 0 1 4 0v1h12v-1a2 2 0 0 1 4 0v1h1" /></svg>
                        <div><strong class="font-semibold">ขนาดใช้ยา:</strong><div class="mt-1">${dose}</div></div>
                    </div>
                    <div class="flex items-start label-unit">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0 mt-1" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3l8 4.5v9l-8 4.5l-8 -4.5v-9l8 -4.5" /><path d="M12 12l8 -4.5" /><path d="M12 12v9" /><path d="M12 12l-8 -4.5" /><path d="M16 5.25l-8 4.5" /></svg>
                        <div><strong class="font-semibold">หน่วยเบิก:</strong><div class="mt-1">${unitInfo}</div></div>
                    </div>
                    <div class="flex items-start label-proposer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0 mt-1" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M12 10m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" /><path d="M6.168 18.849a4 4 0 0 1 3.832 -2.849h4a4 4 0 0 1 3.834 2.855" /></svg>
                        <div><strong class="font-semibold">แพทย์ผู้เสนอ:</strong><div class="mt-1">${proposerInfo}</div></div>
                    </div>
                    <div class="flex items-start label-storage">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0 mt-1" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 4h4v2.5l-2 2.5l2 2.5v2.5h-4v-2.5l2 -2.5l-2 -2.5z" /><path d="M12 4v-1" /><path d="M12 15v1" /><path d="M16.5 6.5l.5 -.5" /><path d="M16.5 13.5l.5 .5" /><path d="M7.5 6.5l-.5 -.5" /><path d="M7.5 13.5l-.5 .5" /></svg>
                        <div><strong class="font-semibold">การจัดเก็บ:</strong><div class="mt-1">${storage}</div></div>
                    </div>
                     ${food && food !== '-' ? `<div class="flex items-start label-food">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 flex-shrink-0 mt-1" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12h18" /><path d="M3 6h18" /><path d="M3 18h18" /></svg>
                        <div><strong class="font-semibold">Food interaction:</strong><div class="mt-1">${food}</div></div>
                    </div>` : ''}
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 mt-auto border-t border-gray-200">
                <div><strong class="font-semibold underline label-notes">หมายเหตุ:</strong><div class="mt-1 text-xl text-gray-800 leading-relaxed">${notesInfo}</div></div>
            </div>
        </div>
    </div>`;
}

// --- INTERACTIVITY SETUP ---
function setupEventListeners() {
    searchInput.addEventListener('input', filterAndRender);
    filterContainer.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const currentActive = filterContainer.querySelector('.active');
            if (currentActive) currentActive.classList.remove('active');
            e.target.classList.add('active');
            filterAndRender();
        }
    });
}

function setupFilters() {
    const categories = allDrugData.reduce((acc, drug) => {
        const druggroup = getDrugGroupCode(drug.code);
        const name = drug.druggroupName || `ยา กลุ่ม ${druggroup}`;
        if (!acc[druggroup]) {
            acc[druggroup] = { name: name.trim(), code: druggroup };
        }
        return acc;
    }, {});

    let filterHtml = '<button class="filter-btn active" data-filter="all">ทั้งหมด</button>';
    Object.values(categories).sort((a,b) => a.code.localeCompare(b.code)).forEach(cat => {
        filterHtml += `<button class="filter-btn tag-filter-${cat.code}" data-filter="${cat.code}">${sanitizeHTML(cat.name)}</button>`;
    });
    filterContainer.innerHTML = filterHtml;
}

function filterAndRender() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    const activeFilter = filterContainer.querySelector('.active').dataset.filter;
    const filteredData = allDrugData.filter(drug => {
        const searchableContent = (drug.name + ' ' + drug.generic + ' ' + drug.sapCode).toLowerCase();
        const matchesSearch = searchTerm === '' || searchableContent.includes(searchTerm);
        const matchesFilter = activeFilter === 'all' || getDrugGroupCode(drug.code) === activeFilter;
        return matchesSearch && matchesFilter;
    });
    renderGroupedCards(filteredData);
}

// --- INITIAL LOAD ---
loadDrugData();
</script>
</body>
</html>
